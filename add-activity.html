<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุถุงูุฉ ูุดุงุท ุนููู ุฌุฏูุฏ</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* ุชูุณููุงุช ุฎุงุตุฉ ูุตูุญุฉ ุงูุฅุถุงูุฉ */
        body {
            background-color: var(--primary-900);
            min-height: 100vh;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(198, 169, 98, 0.3);
            border-radius: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .form-container {
            display: none; /* ูุฎูู ุญุชู ุชุณุฌูู ุงูุฏุฎูู */
            max-width: 900px;
            margin: 40px auto;
            padding: 30px;
            background: rgba(12, 25, 41, 0.9);
            border: 1px solid rgba(198, 169, 98, 0.2);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 20px;
        }

        .form-section {
            display: none; /* ุงูุฃูุณุงู ูุฎููุฉ ุงูุชุฑุงุถูุงู */
            animation: fadeIn 0.4s ease;
        }

        .form-section.active {
            display: block;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .input-grid { grid-template-columns: 1fr; }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: var(--gold-400);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s;
        }

        .form-group input:focus, 
        .form-group select:focus {
            outline: none;
            border-color: var(--gold-400);
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-submit {
            background: linear-gradient(135deg, var(--gold-500), var(--gold-600));
            color: #000;
            font-weight: bold;
            padding: 15px 40px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            font-size: 1.1rem;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
        }

        .btn-submit:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }

        /* ุชูุณูู ุงุฎุชูุงุฑ ุงูููุน */
        .type-selector {
            margin-bottom: 30px;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .helper-text {
            font-size: 0.75rem;
            color: #888;
            margin-top: 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div class="animated-bg">
        <div class="geometric-pattern"></div>
    </div>

    <div id="loginScreen" class="login-container">
        <h2 style="color: var(--gold-400); margin-bottom: 30px;">๐ ุฏุฎูู ุงูุฃุนุถุงุก</h2>
        <div class="form-group">
            <label>ุงูุฑูู ุงููุธููู</label>
            <input type="text" id="loginId" placeholder="ุฃุฏุฎู ุฑููู ุงููุธููู">
        </div>
        <div class="form-group">
            <label>ูููุฉ ุงููุฑูุฑ</label>
            <input type="password" id="loginPass" placeholder="โขโขโขโข">
        </div>
        <button onclick="attemptLogin()" class="btn-submit">ุฏุฎูู</button>
        <p id="loginError" style="color: var(--rose-500); margin-top: 15px; display: none;">ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ</p>
    </div>

    <div id="mainFormScreen" class="form-container">
        <div class="form-header">
            <h2 style="color: #fff;">ุฅุถุงูุฉ ูุดุงุท ุนููู ุฌุฏูุฏ</h2>
            <a href="index.html" style="color: var(--gold-400); text-decoration: none;">๐ ุนูุฏุฉ ููุฑุฆูุณูุฉ</a>
        </div>

        <div class="type-selector">
            <label style="color: #fff; margin-bottom: 10px; display: block;">ุงุฎุชุฑ ููุน ุงููุดุงุท ููุฅุถุงูุฉ:</label>
            <select id="activityTypeSelect" onchange="toggleForm()" style="width: 100%; max-width: 400px; padding: 10px; border-radius: 8px;">
                <option value="">-- ุญุฏุฏ ุงูููุน --</option>
                <option value="participations">๐ ุงููุดุงุฑูุงุช ูุงููุนุงููุงุช (Participations)</option>
                <option value="publications">๐ ุงูุฃุจุญุงุซ ุงูููุดูุฑุฉ (Publications)</option>
                <option value="theses">๐ ุงูุฑุณุงุฆู ุงูุนูููุฉ (Theses)</option>
            </select>
        </div>

        <div id="form-participations" class="form-section">
            <h3 style="color: var(--violet-500); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">ุจูุงูุงุช ุงููุดุงุฑูุฉ / ุงููุนุงููุฉ</h3>
            <div class="input-grid">
                <div class="form-group">
                    <label>ุงูุณูุฉ (ูุฌุฑู)</label>
                    <input type="number" id="part_year" value="1446">
                </div>
                <div class="form-group">
                    <label>ุงูุชุตููู (Category)</label>
                    <select id="part_category">
                        <option value="ุจุญุซ ููุดูุฑ">ุจุญุซ ููุดูุฑ</option>
                        <option value="ูุฑูุฉ ุนูููุฉ">ูุฑูุฉ ุนูููุฉ</option>
                        <option value="ุญุถูุฑ">ุญุถูุฑ</option>
                        <option value="ูุฑุดุฉ ุนูู">ูุฑุดุฉ ุนูู</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ููุน ุงููุดุงุฑูุฉ</label>
                    <select id="part_type">
                        <option value="ูุดุฑ">ูุดุฑ</option>
                        <option value="ูุดุงุฑูุฉ">ูุดุงุฑูุฉ</option>
                        <option value="ุญุถูุฑ">ุญุถูุฑ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ุนููุงู ุงููุดุงุฑูุฉ</label>
                    <input type="text" id="part_title">
                </div>
                <div class="form-group">
                    <label>ุงูููุงู / ุงููุฏููุฉ</label>
                    <input type="text" id="part_location">
                </div>
                <div class="form-group">
                    <label>ุงูุชุงุฑูุฎ</label>
                    <input type="date" id="part_date">
                </div>
                <div class="form-group">
                    <label>ุฃุฑูุงู ุงููุดุงุฑููู (IDs)</label>
                    <input type="text" id="part_ids" placeholder="4280112|4310115">
                    <div class="helper-text">ุงูุตู ุจูู ุงูุฃุฑูุงู ุจุนูุงูุฉ |</div>
                </div>
                <div class="form-group">
                    <label>ุชูุธูู ุงููุณูุ</label>
                    <select id="part_org">
                        <option value="ูุง">ูุง</option>
                        <option value="ูุนู">ูุนู</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ุงููุฌูุฉ / ุงูุฌูุฉ</label>
                    <input type="text" id="part_journal">
                </div>
                <div class="form-group">
                    <label>ูุทุงู ุงูุงุณุชุดูุงุฏุงุช</label>
                    <select id="part_citations">
                        <option value="">(ูุงุฑุบ)</option>
                        <option value="ุฃูู ูู 10">ุฃูู ูู 10</option>
                        <option value="11-20">11-20</option>
                        <option value="ุฃูุซุฑ ูู 20">ุฃูุซุฑ ูู 20</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ุฌูุฉ ุงูููุญ (ุฅู ูุฌุฏ)</label>
                    <input type="text" id="part_grant">
                </div>
                <div class="form-group">
                    <label>ูุดุงุฑูุฉ ุทุงูุจุ</label>
                    <select id="part_student">
                        <option value="ูุง">ูุง</option>
                        <option value="ูุนู">ูุนู</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>ููุงุญุธุงุช</label>
                <textarea id="part_notes" rows="3"></textarea>
            </div>
        </div>

        <div id="form-publications" class="form-section">
            <h3 style="color: var(--emerald-500); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">ุจูุงูุงุช ุงูุจุญุซ ุงูููุดูุฑ</h3>
            <div class="input-grid">
                <div class="form-group">
                    <label>ุงูุณูุฉ (ูุฌุฑู)</label>
                    <input type="number" id="pub_year" value="1446">
                </div>
                <div class="form-group">
                    <label>ุนููุงู ุงูุจุญุซ</label>
                    <input type="text" id="pub_title">
                </div>
                <div class="form-group">
                    <label>ุฃุฑูุงู ุงููุคูููู (IDs)</label>
                    <input type="text" id="pub_authors" placeholder="4280112|4310115">
                    <div class="helper-text">ุงูุตู ุจูู ุงูุฃุฑูุงู ุจุนูุงูุฉ |</div>
                </div>
                <div class="form-group">
                    <label>ุงุณู ุงููุฌูุฉ</label>
                    <input type="text" id="pub_journal">
                </div>
                <div class="form-group">
                    <label>ุชุงุฑูุฎ ุงููุดุฑ (ูููุงุฏู)</label>
                    <input type="date" id="pub_date">
                </div>
                <div class="form-group">
                    <label>ูุทุงู ุงูุงุณุชุดูุงุฏุงุช</label>
                    <select id="pub_citations">
                        <option value="ุฃูู ูู 10">ุฃูู ูู 10</option>
                        <option value="11-20">11-20</option>
                        <option value="21-50">21-50</option>
                        <option value="51-100">51-100</option>
                        <option value="ุฃูุซุฑ ูู 100">ุฃูุซุฑ ูู 100</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ูุดุงุฑูุฉ ุทุงูุจุ</label>
                    <select id="pub_student">
                        <option value="ูุง">ูุง</option>
                        <option value="ูุนู">ูุนู</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="form-theses" class="form-section">
            <h3 style="color: var(--amber-500); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">ุจูุงูุงุช ุงูุฑุณุงูุฉ ุงูุนูููุฉ</h3>
            <div class="input-grid">
                <div class="form-group">
                    <label>ุงูุณูุฉ (ูุฌุฑู)</label>
                    <input type="number" id="thesis_year" value="1446">
                </div>
                <div class="form-group">
                    <label>ุงูุฏุฑุฌุฉ ุงูุนูููุฉ</label>
                    <select id="thesis_type">
                        <option value="ูุงุฌุณุชูุฑ">ูุงุฌุณุชูุฑ</option>
                        <option value="ุฏูุชูุฑุงู">ุฏูุชูุฑุงู</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ุงูุชุฎุตุต</label>
                    <input type="text" id="thesis_spec" value="ูุฑุงุกุงุช">
                </div>
                <div class="form-group">
                    <label>ุงุณู ุงูุทุงูุจ</label>
                    <input type="text" id="thesis_student_name">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>ุนููุงู ุงูุฑุณุงูุฉ</label>
                    <input type="text" id="thesis_title">
                </div>
                <div class="form-group">
                    <label>ุฑูู ุงููุดุฑู ุงูุฑุฆูุณู (ID)</label>
                    <input type="text" id="thesis_supervisor">
                </div>
                <div class="form-group">
                    <label>ุฑูู ุงููุดุฑู ุงููุดุงุฑู (ID)</label>
                    <input type="text" id="thesis_co_supervisor" placeholder="(ุงุฎุชูุงุฑู)">
                </div>
                <div class="form-group">
                    <label>ุฑูู ุงูููุงูุด ุงูุฃูู (ID)</label>
                    <input type="text" id="thesis_exam1">
                </div>
                <div class="form-group">
                    <label>ุฑูู ุงูููุงูุด ุงูุซุงูู (ID)</label>
                    <input type="text" id="thesis_exam2">
                </div>
                <div class="form-group">
                    <label>ุญุงูุฉ ุงูุฑุณุงูุฉ</label>
                    <select id="thesis_status">
                        <option value="ููุฌุฒุฉ">ููุฌุฒุฉ</option>
                        <option value="ุฌุงุฑูุฉ">ุฌุงุฑูุฉ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ุชุงุฑูุฎ ุงูููุงูุดุฉ</label>
                    <input type="date" id="thesis_date">
                </div>
            </div>
        </div>

        <button id="submitBtn" onclick="submitData()" class="btn-submit" style="display:none;">๐ค ุญูุธ ูุฅุฑุณุงู ุงูุจูุงูุงุช</button>
        <p id="statusMsg" style="text-align: center; margin-top: 15px; font-weight: bold;"></p>
    </div>

    <script>
        // ุฑุงุจุท ุงูุณูุฑูุจุช ุงูุฎุงุต ุจู
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbIi7bIwIZCXPtUHnUt5bS2GJAZZjfFqgKSqyEnC97KOPwx03ZGkXCFdZRTcndZOuM/exec';

        // 1. ููุทู ุชุณุฌูู ุงูุฏุฎูู
        async function attemptLogin() {
            const id = document.getElementById('loginId').value;
            const pass = document.getElementById('loginPass').value;
            const errorMsg = document.getElementById('loginError');

            if (pass !== '1429') {
                errorMsg.textContent = "ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ";
                errorMsg.style.display = 'block';
                return;
            }

            try {
                // ุงูุชุญูู ูู ุงูููู faculty.csv
                const response = await fetch('./data/faculty.csv');
                if (!response.ok) throw new Error("File not found");
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    complete: function(results) {
                        const member = results.data.find(m => m.id && m.id.trim() === id.trim());
                        if (member) {
                            // ุฏุฎูู ูุงุฌุญ
                            document.getElementById('loginScreen').style.display = 'none';
                            document.getElementById('mainFormScreen').style.display = 'block';
                            // ุชุฎุฒูู ูุนุฑู ุงูุนุถู ูุงุณุชุฎุฏุงูู ุงูุชุฑุงุถูุงู ุฅุฐุง ุฃุฑุฏุช
                            localStorage.setItem('currentUser', JSON.stringify(member));
                        } else {
                            errorMsg.textContent = "ุฑูู ุงูุนุถู ุบูุฑ ููุฌูุฏ ูู ุงูุณุฌูุงุช";
                            errorMsg.style.display = 'block';
                        }
                    }
                });
            } catch (error) {
                console.warn("Could not load faculty.csv, bypassing ID check based on user request context.");
                // ูู ุญุงู ูุดู ุชุญููู ุงูููู (ูุซูุงู ูุญููุงู)ุ ุงุณูุญ ุจุงูุฏุฎูู ููุชุฌุฑุจุฉ ุฅุฐุง ูุงูุช ูููุฉ ุงููุฑูุฑ ุตุญูุญุฉ
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainFormScreen').style.display = 'block';
            }
        }

        // 2. ุฅุธูุงุฑ ุงููููุฐุฌ ุงูููุงุณุจ
        function toggleForm() {
            // ุฅุฎูุงุก ุงููู
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.getElementById('submitBtn').style.display = 'none';
            
            const selectedType = document.getElementById('activityTypeSelect').value;
            if (selectedType) {
                document.getElementById('form-' + selectedType).classList.add('active');
                document.getElementById('submitBtn').style.display = 'block';
            }
        }

        // 3. ุฌูุน ูุฅุฑุณุงู ุงูุจูุงูุงุช
        function submitData() {
            const btn = document.getElementById('submitBtn');
            const statusMsg = document.getElementById('statusMsg');
            const type = document.getElementById('activityTypeSelect').value;

            // ุชุนุทูู ุงูุฒุฑ
            btn.disabled = true;
            btn.textContent = "ุฌุงุฑู ุงูุฅุฑุณุงู...";
            statusMsg.textContent = "";

            let formData = { formType: type };

            // ุฌูุน ุงูุจูุงูุงุช ุญุณุจ ุงูููุน
            if (type === 'participations') {
                formData.year = document.getElementById('part_year').value;
                formData.category = document.getElementById('part_category').value;
                formData.participation_type = document.getElementById('part_type').value;
                formData.title = document.getElementById('part_title').value;
                formData.location = document.getElementById('part_location').value;
                formData.date = document.getElementById('part_date').value;
                formData.participant_ids = document.getElementById('part_ids').value;
                formData.organized_by_department = document.getElementById('part_org').value;
                formData.journal = document.getElementById('part_journal').value;
                formData.citations_range = document.getElementById('part_citations').value;
                formData.granting_body = document.getElementById('part_grant').value;
                formData.student_author = document.getElementById('part_student').value;
                formData.notes = document.getElementById('part_notes').value;
            } 
            else if (type === 'publications') {
                formData.year = document.getElementById('pub_year').value;
                formData.title = document.getElementById('pub_title').value;
                formData.authors_ids = document.getElementById('pub_authors').value;
                formData.journal = document.getElementById('pub_journal').value;
                formData.publish_date = document.getElementById('pub_date').value;
                formData.citations_range = document.getElementById('pub_citations').value;
                formData.student_author = document.getElementById('pub_student').value;
            }
            else if (type === 'theses') {
                formData.year = document.getElementById('thesis_year').value;
                formData.type = document.getElementById('thesis_type').value;
                formData.specialization = document.getElementById('thesis_spec').value;
                formData.student_name = document.getElementById('thesis_student_name').value;
                formData.title = document.getElementById('thesis_title').value;
                formData.supervisor_id = document.getElementById('thesis_supervisor').value;
                formData.co_supervisor_id = document.getElementById('thesis_co_supervisor').value;
                formData.examiner1_id = document.getElementById('thesis_exam1').value;
                formData.examiner2_id = document.getElementById('thesis_exam2').value;
                formData.status = document.getElementById('thesis_status').value;
                formData.defense_date = document.getElementById('thesis_date').value;
            }

            // ุฅุฑุณุงู ุงูุจูุงูุงุช
            // ูุณุชุฎุฏู text/plain ูุชุฌูุจ ูุดุงูู CORS ูุน Google Apps Script
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(formData),
                headers: { "Content-Type": "text/plain" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusMsg.style.color = 'var(--emerald-500)';
                    statusMsg.textContent = `โ ุชู ุงูุญูุธ ุจูุฌุงุญ! ุฑูู ุงูุนูููุฉ: ${data.id}`;
                    btn.textContent = "ุชู ุงูุฅุฑุณุงู";
                    
                    // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ ุจุนุฏ 3 ุซูุงูู
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusMsg.style.color = 'var(--rose-500)';
                statusMsg.textContent = "โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุฅุฑุณุงู. ุชุฃูุฏ ูู ุงูุงุชุตุงู.";
                btn.disabled = false;
                btn.textContent = "ุญุงูู ูุฑุฉ ุฃุฎุฑู";
            });
        }
    </script>
</body>
</html>
