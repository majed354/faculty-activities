<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø· Ø¹Ù„Ù…ÙŠ Ø¬Ø¯ÙŠØ¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
        body { background-color: var(--primary-900); min-height: 100vh; }
        .login-container {
            max-width: 400px; margin: 100px auto; padding: 40px;
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(198, 169, 98, 0.3);
            border-radius: 20px; text-align: center; backdrop-filter: blur(10px);
        }
        .form-container {
            display: none; max-width: 900px; margin: 40px auto; padding: 30px;
            background: rgba(12, 25, 41, 0.9); border: 1px solid rgba(198, 169, 98, 0.2);
            border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .form-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px;
        }
        .form-section { display: none; animation: fadeIn 0.4s ease; }
        .form-section.active { display: block; }
        .input-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .input-grid { grid-template-columns: 1fr; } }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: var(--gold-400); margin-bottom: 8px; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1); color: #fff; border-radius: 10px;
            font-family: 'Cairo', sans-serif; transition: all 0.3s;
        }
        .form-group option { background: #1a1a2e; color: #fff; }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--gold-400); background: rgba(255, 255, 255, 0.1);
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ø§Ù„Ù…Ø®ÙÙŠ */
        .external-input {
            display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
            margin-top: 10px;
            border-color: var(--sky-500) !important;
            background: rgba(14, 165, 233, 0.1) !important;
        }
        .external-input::placeholder { color: #aaa; }

        .btn-submit {
            background: linear-gradient(135deg, var(--gold-500), var(--gold-600)); color: #000;
            font-weight: bold; padding: 15px 40px; border: none; border-radius: 12px;
            cursor: pointer; width: 100%; font-size: 1.1rem; margin-top: 20px; transition: transform 0.2s;
        }
        .btn-submit:hover { transform: translateY(-2px); }
        .btn-submit:disabled { background: #555; cursor: not-allowed; }
        .type-selector {
            margin-bottom: 30px; background: rgba(255,255,255,0.05);
            padding: 20px; border-radius: 15px; text-align: center;
        }
        .helper-text { font-size: 0.75rem; color: #888; margin-top: 5px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="animated-bg">
        <div class="geometric-pattern"></div>
    </div>

    <div id="loginScreen" class="login-container">
        <h2 style="color: var(--gold-400); margin-bottom: 30px;">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2>
        <div class="form-group">
            <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
            <input type="text" id="loginId" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
        </div>
        <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢">
        </div>
        <button onclick="attemptLogin()" class="btn-submit">Ø¯Ø®ÙˆÙ„</button>
        <p id="loginError" style="color: var(--rose-500); margin-top: 15px; display: none;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>
    </div>

    <div id="mainFormScreen" class="form-container">
        <div class="form-header">
            <h2 style="color: #fff;">Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø· Ø¹Ù„Ù…ÙŠ Ø¬Ø¯ÙŠØ¯</h2>
            <a href="index.html" style="color: var(--gold-400); text-decoration: none;">ğŸ  Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </div>

        <div class="type-selector">
            <label style="color: #fff; margin-bottom: 10px; display: block;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„Ø¥Ø¶Ø§ÙØ©:</label>
            <select id="activityTypeSelect" onchange="toggleForm()" style="width: 100%; max-width: 400px; padding: 10px; border-radius: 8px;">
                <option value="">-- Ø­Ø¯Ø¯ Ø§Ù„Ù†ÙˆØ¹ --</option>
                <option value="participations">ğŸ“… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª ÙˆØ§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª (Participations)</option>
                <option value="publications">ğŸ“š Ø§Ù„Ø£Ø¨Ø­Ø§Ø« Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© (Publications)</option>
                <option value="theses">ğŸ“ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù„Ù…ÙŠØ© (Theses)</option>
            </select>
        </div>

        <div id="form-participations" class="form-section">
            <h3 style="color: var(--violet-500); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© / Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©</h3>
            <div class="input-grid">
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ù†Ø© (Ù‡Ø¬Ø±ÙŠ)</label>
                    <input type="number" id="part_year" value="1446">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØµÙ†ÙŠÙ (Category)</label>
                    <select id="part_category">
                        <option value="Ø¨Ø­Ø« Ù…Ù†Ø´ÙˆØ±">Ø¨Ø­Ø« Ù…Ù†Ø´ÙˆØ±</option>
                        <option value="ÙˆØ±Ù‚Ø© Ø¹Ù„Ù…ÙŠØ©">ÙˆØ±Ù‚Ø© Ø¹Ù„Ù…ÙŠØ©</option>
                        <option value="Ø­Ø¶ÙˆØ±">Ø­Ø¶ÙˆØ±</option>
                        <option value="ÙˆØ±Ø´Ø© Ø¹Ù…Ù„">ÙˆØ±Ø´Ø© Ø¹Ù…Ù„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</label>
                    <select id="part_type">
                        <option value="Ù†Ø´Ø±">Ù†Ø´Ø±</option>
                        <option value="Ù…Ø´Ø§Ø±ÙƒØ©">Ù…Ø´Ø§Ø±ÙƒØ©</option>
                        <option value="Ø­Ø¶ÙˆØ±">Ø­Ø¶ÙˆØ±</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</label>
                    <input type="text" id="part_title">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙƒØ§Ù† / Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                    <input type="text" id="part_location">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="part_date">
                </div>
                <div class="form-group">
                    <label>Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (IDs)</label>
                    <input type="text" id="part_ids" placeholder="4280112|4310115">
                </div>
                <div class="form-group">
                    <label>ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù‚Ø³Ù…ØŸ</label>
                    <select id="part_org">
                        <option value="Ù„Ø§">Ù„Ø§</option>
                        <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¬Ù„Ø© / Ø§Ù„Ø¬Ù‡Ø©</label>
                    <input type="text" id="part_journal">
                </div>
                <div class="form-group">
                    <label>Ù†Ø·Ø§Ù‚ Ø§Ù„Ø§Ø³ØªØ´Ù‡Ø§Ø¯Ø§Øª</label>
                    <select id="part_citations">
                        <option value="">(ÙØ§Ø±Øº)</option>
                        <option value="Ø£Ù‚Ù„ Ù…Ù† 10">Ø£Ù‚Ù„ Ù…Ù† 10</option>
                        <option value="11-20">11-20</option>
                        <option value="Ø£ÙƒØ«Ø± Ù…Ù† 20">Ø£ÙƒØ«Ø± Ù…Ù† 20</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†Ø­ (Ø¥Ù† ÙˆØ¬Ø¯)</label>
                    <input type="text" id="part_grant">
                </div>
                <div class="form-group">
                    <label>Ù…Ø´Ø§Ø±ÙƒØ© Ø·Ø§Ù„Ø¨ØŸ</label>
                    <select id="part_student">
                        <option value="Ù„Ø§">Ù„Ø§</option>
                        <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <textarea id="part_notes" rows="3"></textarea>
            </div>
        </div>

        <div id="form-publications" class="form-section">
            <h3 style="color: var(--emerald-500); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ù†Ø´ÙˆØ±</h3>
            <div class="input-grid">
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ù†Ø© (Ù‡Ø¬Ø±ÙŠ)</label>
                    <input type="number" id="pub_year" value="1446">
                </div>
                <div class="form-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø­Ø«</label>
                    <input type="text" id="pub_title">
                </div>
                <div class="form-group">
                    <label>Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¤Ù„ÙÙŠÙ† (IDs)</label>
                    <input type="text" id="pub_authors" placeholder="4280112|4310115">
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø©</label>
                    <input type="text" id="pub_journal">
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø± (Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</label>
                    <input type="date" id="pub_date">
                </div>
                <div class="form-group">
                    <label>Ù†Ø·Ø§Ù‚ Ø§Ù„Ø§Ø³ØªØ´Ù‡Ø§Ø¯Ø§Øª</label>
                    <select id="pub_citations">
                        <option value="Ø£Ù‚Ù„ Ù…Ù† 10">Ø£Ù‚Ù„ Ù…Ù† 10</option>
                        <option value="11-20">11-20</option>
                        <option value="21-50">21-50</option>
                        <option value="51-100">51-100</option>
                        <option value="Ø£ÙƒØ«Ø± Ù…Ù† 100">Ø£ÙƒØ«Ø± Ù…Ù† 100</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ù…Ø´Ø§Ø±ÙƒØ© Ø·Ø§Ù„Ø¨ØŸ</label>
                    <select id="pub_student">
                        <option value="Ù„Ø§">Ù„Ø§</option>
                        <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="form-theses" class="form-section">
            <h3 style="color: var(--amber-500); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</h3>
            <div class="input-grid">
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ù†Ø© (Ù‡Ø¬Ø±ÙŠ)</label>
                    <input type="number" id="thesis_year" value="1446">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</label>
                    <select id="thesis_type">
                        <option value="Ù…Ø§Ø¬Ø³ØªÙŠØ±">Ù…Ø§Ø¬Ø³ØªÙŠØ±</option>
                        <option value="Ø¯ÙƒØªÙˆØ±Ø§Ù‡">Ø¯ÙƒØªÙˆØ±Ø§Ù‡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ®ØµØµ</label>
                    <select id="thesis_spec">
                        <option value="Ù‚Ø±Ø§Ø¡Ø§Øª">Ù‚Ø±Ø§Ø¡Ø§Øª</option>
                        <option value="Ø¯Ø±Ø§Ø³Ø§Øª Ù‚Ø±Ø¢Ù†ÙŠØ©">Ø¯Ø±Ø§Ø³Ø§Øª Ù‚Ø±Ø¢Ù†ÙŠØ©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                    <input type="text" id="thesis_student_name">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                    <input type="text" id="thesis_title">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                    <select id="thesis_supervisor" class="faculty-select" onchange="toggleExternalInput(this)">
                        <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                    </select>
                    <input type="text" id="thesis_supervisor_ext" class="external-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ù‡Ù†Ø§...">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ</label>
                    <select id="thesis_co_supervisor" class="faculty-select" onchange="toggleExternalInput(this)">
                        <option value="">-- Ø§Ø®ØªÙŠØ§Ø±ÙŠ --</option>
                    </select>
                    <input type="text" id="thesis_co_supervisor_ext" class="external-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ...">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ù†Ø§Ù‚Ø´ Ø§Ù„Ø£ÙˆÙ„</label>
                    <select id="thesis_exam1" class="faculty-select" onchange="toggleExternalInput(this)">
                        <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                    </select>
                    <input type="text" id="thesis_exam1_ext" class="external-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ù‚Ø´ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ù‡Ù†Ø§...">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ù†Ø§Ù‚Ø´ Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
                    <select id="thesis_exam2" class="faculty-select" onchange="toggleExternalInput(this)">
                        <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                    </select>
                    <input type="text" id="thesis_exam2_ext" class="external-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ù‚Ø´ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ù‡Ù†Ø§...">
                </div>

                <div class="form-group">
                    <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                    <select id="thesis_status">
                        <option value="Ù…Ù†Ø¬Ø²Ø©">Ù…Ù†Ø¬Ø²Ø©</option>
                        <option value="Ø¬Ø§Ø±ÙŠØ©">Ø¬Ø§Ø±ÙŠØ©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø©</label>
                    <input type="date" id="thesis_date">
                </div>
            </div>
        </div>

        <button id="submitBtn" onclick="submitData()" class="btn-submit" style="display:none;">ğŸ“¤ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <p id="statusMsg" style="text-align: center; margin-top: 15px; font-weight: bold;"></p>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbIi7bIwIZCXPtUHnUt5bS2GJAZZjfFqgKSqyEnC97KOPwx03ZGkXCFdZRTcndZOuM/exec';
        let facultyList = [];

        async function attemptLogin() {
            const id = document.getElementById('loginId').value;
            const pass = document.getElementById('loginPass').value;
            const errorMsg = document.getElementById('loginError');

            if (pass !== '1429') {
                errorMsg.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
                errorMsg.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('./data/faculty.csv');
                if (!response.ok) throw new Error("File not found");
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    complete: function(results) {
                        facultyList = results.data.filter(m => m.id && m.name);
                        populateFacultyDropdowns();
                        const member = facultyList.find(m => m.id && m.id.trim() === id.trim());
                        if (member) {
                            document.getElementById('loginScreen').style.display = 'none';
                            document.getElementById('mainFormScreen').style.display = 'block';
                        } else {
                            errorMsg.textContent = "Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª";
                            errorMsg.style.display = 'block';
                        }
                    }
                });
            } catch (error) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainFormScreen').style.display = 'block';
            }
        }

        function populateFacultyDropdowns() {
            const uniqueFaculty = [];
            const map = new Map();
            for (const item of facultyList) {
                if(!map.has(item.id)){
                    map.set(item.id, true);
                    uniqueFaculty.push({ id: item.id, name: item.name });
                }
            }
            uniqueFaculty.sort((a, b) => a.name.localeCompare(b.name, 'ar'));

            const selects = document.querySelectorAll('.faculty-select');
            
            selects.forEach(select => {
                const firstOption = select.options[0];
                select.innerHTML = '';
                select.appendChild(firstOption);

                if (firstOption.text === "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...") {
                    firstOption.text = "-- Ø§Ø®ØªØ± Ø¹Ø¶Ùˆ Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³ --";
                }

                // 1. Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø®Ø§Ø±Ø¬ÙŠ Ø«Ø§Ø¨Øª
                const extOption = document.createElement('option');
                extOption.value = "external";
                extOption.text = "ğŸ‘¤ Ù…Ù†Ø§Ù‚Ø´/Ù…Ø´Ø±Ù Ø®Ø§Ø±Ø¬ÙŠ (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)";
                extOption.style.fontWeight = "bold";
                extOption.style.color = "#0ea5e9";
                select.appendChild(extOption);

                // ÙØ§ØµÙ„
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.text = "------------------";
                select.appendChild(separator);

                // 2. Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù‚Ø³Ù…
                uniqueFaculty.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.text = member.name;
                    select.appendChild(option);
                });
            });
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
        function toggleExternalInput(selectElement) {
            // Ù†Ø¨Ø­Ø« Ø¹Ù† Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø°ÙŠ ÙŠÙ„ÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
            const inputField = selectElement.nextElementSibling;
            if (selectElement.value === 'external') {
                inputField.style.display = 'block';
                inputField.focus();
            } else {
                inputField.style.display = 'none';
                inputField.value = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
            }
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ø¥Ù…Ø§ ID Ø§Ù„Ø¹Ø¶Ùˆ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ)
        function getMemberValue(selectId) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(selectId + '_ext');
            
            if (select.value === 'external') {
                return input.value.trim(); // Ù†Ø±Ø¬Ø¹ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªÙˆØ¨
            }
            return select.value; // Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù€ ID
        }

        function toggleForm() {
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.getElementById('submitBtn').style.display = 'none';
            const selectedType = document.getElementById('activityTypeSelect').value;
            if (selectedType) {
                document.getElementById('form-' + selectedType).classList.add('active');
                document.getElementById('submitBtn').style.display = 'block';
            }
        }

        function submitData() {
            const btn = document.getElementById('submitBtn');
            const statusMsg = document.getElementById('statusMsg');
            const type = document.getElementById('activityTypeSelect').value;

            btn.disabled = true;
            btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
            statusMsg.textContent = "";

            let formData = { formType: type };

            if (type === 'participations') {
                formData.year = document.getElementById('part_year').value;
                formData.category = document.getElementById('part_category').value;
                formData.participation_type = document.getElementById('part_type').value;
                formData.title = document.getElementById('part_title').value;
                formData.location = document.getElementById('part_location').value;
                formData.date = document.getElementById('part_date').value;
                formData.participant_ids = document.getElementById('part_ids').value;
                formData.organized_by_department = document.getElementById('part_org').value;
                formData.journal = document.getElementById('part_journal').value;
                formData.citations_range = document.getElementById('part_citations').value;
                formData.granting_body = document.getElementById('part_grant').value;
                formData.student_author = document.getElementById('part_student').value;
                formData.notes = document.getElementById('part_notes').value;
            } 
            else if (type === 'publications') {
                formData.year = document.getElementById('pub_year').value;
                formData.title = document.getElementById('pub_title').value;
                formData.authors_ids = document.getElementById('pub_authors').value;
                formData.journal = document.getElementById('pub_journal').value;
                formData.publish_date = document.getElementById('pub_date').value;
                formData.citations_range = document.getElementById('pub_citations').value;
                formData.student_author = document.getElementById('pub_student').value;
            }
            else if (type === 'theses') {
                formData.year = document.getElementById('thesis_year').value;
                formData.type = document.getElementById('thesis_type').value;
                formData.specialization = document.getElementById('thesis_spec').value;
                formData.student_name = document.getElementById('thesis_student_name').value;
                formData.title = document.getElementById('thesis_title').value;
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØµØ­ÙŠØ­Ø© (Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù…)
                formData.supervisor_id = getMemberValue('thesis_supervisor');
                formData.co_supervisor_id = getMemberValue('thesis_co_supervisor');
                formData.examiner1_id = getMemberValue('thesis_exam1');
                formData.examiner2_id = getMemberValue('thesis_exam2');

                formData.status = document.getElementById('thesis_status').value;
                formData.defense_date = document.getElementById('thesis_date').value;
            }

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(formData),
                headers: { "Content-Type": "text/plain" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusMsg.style.color = 'var(--emerald-500)';
                    statusMsg.textContent = `âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${data.id}`;
                    btn.textContent = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
                    setTimeout(() => { location.reload(); }, 3000);
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusMsg.style.color = 'var(--rose-500)';
                statusMsg.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.";
                btn.disabled = false;
                btn.textContent = "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
            });
        }
    </script>
</body>
</html>
