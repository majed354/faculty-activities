<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø· Ø¹Ù„Ù…ÙŠ Ø¬Ø¯ÙŠØ¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* =========================================
           ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        ========================================= */
        body { background-color: var(--primary-900); min-height: 100vh; }
        
        .login-container {
            max-width: 400px; margin: 100px auto; padding: 40px;
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(198, 169, 98, 0.3);
            border-radius: 20px; text-align: center; backdrop-filter: blur(10px);
        }
        
        .form-container {
            display: none; max-width: 900px; margin: 40px auto; padding: 30px;
            background: rgba(12, 25, 41, 0.95); border: 1px solid rgba(198, 169, 98, 0.2);
            border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        .form-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px;
        }
        
        .form-section { display: none; animation: fadeIn 0.4s ease; }
        .form-section.active { display: block; }
        
        .input-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .input-grid { grid-template-columns: 1fr; } }
        
        .form-group { margin-bottom: 15px; position: relative; }
        .form-group label { display: block; color: var(--gold-400); margin-bottom: 8px; font-size: 0.9rem; }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1); color: #fff; border-radius: 10px;
            font-family: 'Cairo', sans-serif; transition: all 0.3s;
        }
        
        .form-group option { background: #1a1a2e; color: #fff; }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--gold-400); background: rgba(255, 255, 255, 0.1);
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ */
        .hijri-input {
            direction: ltr; /* Ù„ØªØ³Ù‡ÙŠÙ„ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… */
            text-align: right;
            letter-spacing: 1px;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ø§Ù„Ù…Ø®ÙÙŠ */
        .external-input {
            display: none; margin-top: 10px;
            border-color: var(--sky-500) !important;
            background: rgba(14, 165, 233, 0.1) !important;
        }
        .external-input::placeholder { color: #aaa; }

        .btn-submit {
            background: linear-gradient(135deg, var(--gold-500), var(--gold-600)); color: #000;
            font-weight: bold; padding: 15px 40px; border: none; border-radius: 12px;
            cursor: pointer; width: 100%; font-size: 1.1rem; margin-top: 20px; transition: transform 0.2s;
        }
        .btn-submit:hover { transform: translateY(-2px); }
        .btn-submit:disabled { background: #555; cursor: not-allowed; }
        
        .type-selector {
            margin-bottom: 30px; background: rgba(255,255,255,0.05);
            padding: 20px; border-radius: 15px; text-align: center;
        }
        optgroup { color: var(--gold-400); background: #0c1929; font-weight: bold; }

        /* =========================================
           ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ (Multi-Select)
        ========================================= */
        .multi-select-wrapper {
            display: flex; gap: 10px;
        }
        .btn-add-member {
            background: var(--emerald-500); color: white; border: none;
            padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        .btn-add-member:hover { background: var(--emerald-600); }
        
        .selected-members-list {
            margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px;
        }
        .member-tag {
            background: rgba(198, 169, 98, 0.2); border: 1px solid var(--gold-400);
            padding: 5px 10px; border-radius: 15px; font-size: 0.85rem; color: white;
            display: flex; align-items: center; gap: 8px;
        }
        .remove-tag {
            cursor: pointer; color: var(--rose-500); font-weight: bold; font-size: 1.1rem; line-height: 1;
        }
        .remove-tag:hover { color: var(--rose-600); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="animated-bg">
        <div class="geometric-pattern"></div>
    </div>

    <div id="loginScreen" class="login-container">
        <h2 style="color: var(--gold-400); margin-bottom: 30px;">ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2>
        <div class="form-group">
            <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
            <input type="text" id="loginId" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
        </div>
        <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢">
        </div>
        <button onclick="attemptLogin()" class="btn-submit">Ø¯Ø®ÙˆÙ„</button>
        <p id="loginError" style="color: var(--rose-500); margin-top: 15px; display: none;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©</p>
    </div>

    <div id="mainFormScreen" class="form-container">
        <div class="form-header">
            <h2 style="color: #fff;">Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø· Ø¹Ù„Ù…ÙŠ Ø¬Ø¯ÙŠØ¯</h2>
            <a href="index.html" style="color: var(--gold-400); text-decoration: none;">ğŸ  Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </div>

        <div class="type-selector">
            <label style="color: #fff; margin-bottom: 10px; display: block; font-size: 1.1rem;">Ø­Ø¯Ø¯ Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·:</label>
            <select id="mainActivitySelect" onchange="handleActivityChange()" style="width: 100%; max-width: 500px; padding: 12px; border-radius: 8px; font-size: 1rem;">
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© --</option>
                
                <optgroup label="ğŸ“š Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø¹Ù„Ù…ÙŠ">
                    <option value="pub_research">Ø¨Ø­Ø« Ø¹Ù„Ù…ÙŠ Ù…Ù†Ø´ÙˆØ±</option>
                </optgroup>

                <optgroup label="ğŸ“ Ø§Ù„Ø¥Ø´Ø±Ø§Ù ÙˆØ§Ù„Ù…Ù†Ø§Ù‚Ø´Ø©">
                    <option value="thesis_supervision">Ø¥Ø´Ø±Ø§Ù Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø¹Ù„Ù…ÙŠØ©</option>
                    <option value="thesis_discussion_internal">Ù…Ù†Ø§Ù‚Ø´Ø© Ø¯Ø§Ø®Ù„ÙŠØ© (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø³Ù…)</option>
                </optgroup>

                <optgroup label="ğŸ“… Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ù„Ù…ÙŠØ©">
                    <option value="event_discussion_external">Ù…Ù†Ø§Ù‚Ø´Ø© Ø®Ø§Ø±Ø¬ÙŠØ©</option>
                    <option value="event_conf_attend">Ø­Ø¶ÙˆØ± Ù…Ø¤ØªÙ…Ø±</option>
                    <option value="event_conf_part">Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ù…Ø¤ØªÙ…Ø±</option>
                    <option value="event_workshop_attend">Ø­Ø¶ÙˆØ± Ù†Ø¯ÙˆØ© / ÙˆØ±Ø´Ø© Ø¹Ù…Ù„</option>
                    <option value="event_workshop_part">Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ù†Ø¯ÙˆØ© / ÙˆØ±Ø´Ø© Ø¹Ù…Ù„</option>
                    <option value="event_student_research">Ø¨Ø­ÙˆØ« Ø§Ù„Ø·Ù„Ø§Ø¨</option>
                </optgroup>
            </select>
        </div>

        <div id="form-publications" class="form-section">
            <h3 style="color: var(--emerald-500); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ù†Ø´ÙˆØ±</h3>
            <div class="input-grid">
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ù†Ø© (Ù‡Ø¬Ø±ÙŠ)</label>
                    <input type="number" id="pub_year" value="1446">
                </div>
                <div class="form-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø­Ø«</label>
                    <input type="text" id="pub_title">
                </div>

                <div class="form-group" style="grid-column: span 2;">
                    <label>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ø¨Ø­Ø« (Ù…Ù† Ø§Ù„Ù‚Ø³Ù…)</label>
                    <div class="multi-select-wrapper">
                        <select id="pub_author_select" class="faculty-select">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ù„Ù„Ø¥Ø¶Ø§ÙØ© --</option>
                        </select>
                        <button type="button" class="btn-add-member" onclick="addMemberToList('pub_author_select', 'pub_authors_list', 'pub_authors_hidden')">Ø¥Ø¶Ø§ÙØ© +</button>
                    </div>
                    <div id="pub_authors_list" class="selected-members-list"></div>
                    <input type="hidden" id="pub_authors_hidden">
                </div>

                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø©</label>
                    <input type="text" id="pub_journal">
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø± (Ù‡Ø¬Ø±ÙŠ: YYYY-MM-DD)</label>
                    <input type="text" id="pub_date" class="hijri-input" placeholder="Ù…Ø«Ø§Ù„: 1446-05-20">
                </div>
                <div class="form-group">
                    <label>Ù†Ø·Ø§Ù‚ Ø§Ù„Ø§Ø³ØªØ´Ù‡Ø§Ø¯Ø§Øª</label>
                    <select id="pub_citations">
                        <option value="Ø£Ù‚Ù„ Ù…Ù† 10">Ø£Ù‚Ù„ Ù…Ù† 10</option>
                        <option value="11-20">11-20</option>
                        <option value="21-50">21-50</option>
                        <option value="51-100">51-100</option>
                        <option value="Ø£ÙƒØ«Ø± Ù…Ù† 100">Ø£ÙƒØ«Ø± Ù…Ù† 100</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ù…Ø´Ø§Ø±ÙƒØ© Ø·Ø§Ù„Ø¨ØŸ</label>
                    <select id="pub_student">
                        <option value="Ù„Ø§">Ù„Ø§</option>
                        <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="form-theses" class="form-section">
            <h3 style="color: var(--amber-500); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</h3>
            <div class="input-grid">
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ù†Ø© (Ù‡Ø¬Ø±ÙŠ)</label>
                    <input type="number" id="thesis_year" value="1446">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</label>
                    <select id="thesis_type">
                        <option value="Ù…Ø§Ø¬Ø³ØªÙŠØ±">Ù…Ø§Ø¬Ø³ØªÙŠØ±</option>
                        <option value="Ø¯ÙƒØªÙˆØ±Ø§Ù‡">Ø¯ÙƒØªÙˆØ±Ø§Ù‡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ®ØµØµ</label>
                    <select id="thesis_spec">
                        <option value="Ù‚Ø±Ø§Ø¡Ø§Øª">Ù‚Ø±Ø§Ø¡Ø§Øª</option>
                        <option value="Ø¯Ø±Ø§Ø³Ø§Øª Ù‚Ø±Ø¢Ù†ÙŠØ©">Ø¯Ø±Ø§Ø³Ø§Øª Ù‚Ø±Ø¢Ù†ÙŠØ©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                    <input type="text" id="thesis_student_name">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                    <input type="text" id="thesis_title">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                    <select id="thesis_supervisor" class="faculty-select" onchange="toggleExternalInput(this)">
                        <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                    </select>
                    <input type="text" id="thesis_supervisor_ext" class="external-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ...">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ</label>
                    <select id="thesis_co_supervisor" class="faculty-select" onchange="toggleExternalInput(this)">
                        <option value="">-- Ø§Ø®ØªÙŠØ§Ø±ÙŠ --</option>
                    </select>
                    <input type="text" id="thesis_co_supervisor_ext" class="external-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ...">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ù†Ø§Ù‚Ø´ Ø§Ù„Ø£ÙˆÙ„</label>
                    <select id="thesis_exam1" class="faculty-select" onchange="toggleExternalInput(this)">
                        <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                    </select>
                    <input type="text" id="thesis_exam1_ext" class="external-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ù‚Ø´ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ...">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ù†Ø§Ù‚Ø´ Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
                    <select id="thesis_exam2" class="faculty-select" onchange="toggleExternalInput(this)">
                        <option value="">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>
                    </select>
                    <input type="text" id="thesis_exam2_ext" class="external-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ù‚Ø´ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ...">
                </div>

                <div class="form-group">
                    <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                    <select id="thesis_status">
                        <option value="Ù…Ù†Ø¬Ø²Ø©">Ù…Ù†Ø¬Ø²Ø©</option>
                        <option value="Ø¬Ø§Ø±ÙŠØ©">Ø¬Ø§Ø±ÙŠØ©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø© (Ù‡Ø¬Ø±ÙŠ: YYYY-MM-DD)</label>
                    <input type="text" id="thesis_date" class="hijri-input" placeholder="Ù…Ø«Ø§Ù„: 1446-05-20">
                </div>
            </div>
        </div>

        <div id="form-participations" class="form-section">
            <h3 style="color: var(--violet-500); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ© / Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</h3>
            
            <input type="hidden" id="part_category_hidden">
            <input type="hidden" id="part_type_hidden">

            <div class="input-grid">
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ù†Ø© (Ù‡Ø¬Ø±ÙŠ)</label>
                    <input type="number" id="part_year" value="1446">
                </div>
                
                <div class="form-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ© / Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</label>
                    <input type="text" id="part_title">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙƒØ§Ù† / Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†Ø¸Ù…Ø©</label>
                    <input type="text" id="part_location">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ø¬Ø±ÙŠ: YYYY-MM-DD)</label>
                    <input type="text" id="part_date" class="hijri-input" placeholder="Ù…Ø«Ø§Ù„: 1446-05-20">
                </div>

                <div class="form-group" style="grid-column: span 2;">
                    <label>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† (Ù…Ù† Ø§Ù„Ù‚Ø³Ù…)</label>
                    <div class="multi-select-wrapper">
                        <select id="part_ids_select" class="faculty-select">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ù„Ù„Ø¥Ø¶Ø§ÙØ© --</option>
                        </select>
                        <button type="button" class="btn-add-member" onclick="addMemberToList('part_ids_select', 'part_ids_list', 'part_ids_hidden')">Ø¥Ø¶Ø§ÙØ© +</button>
                    </div>
                    <div id="part_ids_list" class="selected-members-list"></div>
                    <input type="hidden" id="part_ids_hidden">
                </div>

                <div class="form-group">
                    <label>ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù‚Ø³Ù…ØŸ</label>
                    <select id="part_org">
                        <option value="Ù„Ø§">Ù„Ø§</option>
                        <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø© / Ø§Ù„Ø¬Ù‡Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="text" id="part_journal">
                </div>
                
                <div class="form-group">
                    <label>Ù…Ø´Ø§Ø±ÙƒØ© Ø·Ø§Ù„Ø¨ØŸ</label>
                    <select id="part_student">
                        <option value="Ù„Ø§">Ù„Ø§</option>
                        <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                <textarea id="part_notes" rows="2"></textarea>
            </div>
        </div>

        <button id="submitBtn" onclick="submitData()" class="btn-submit" style="display:none;">ğŸ“¤ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <p id="statusMsg" style="text-align: center; margin-top: 15px; font-weight: bold;"></p>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbIi7bIwIZCXPtUHnUt5bS2GJAZZjfFqgKSqyEnC97KOPwx03ZGkXCFdZRTcndZOuM/exec';
        let facultyList = [];
        let currentTargetSheet = '';

        // ÙƒØ§Ø¦Ù†Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© (Ø§Ù„Ù…Ø¤Ù„ÙÙˆÙ† ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†)
        // Key: List ID, Value: Array of {id, name}
        let selectedMembersData = {};

        async function attemptLogin() {
            const id = document.getElementById('loginId').value;
            const pass = document.getElementById('loginPass').value;
            const errorMsg = document.getElementById('loginError');

            if (pass !== '1429') {
                errorMsg.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
                errorMsg.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('./data/faculty.csv');
                if (!response.ok) throw new Error("File not found");
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    complete: function(results) {
                        facultyList = results.data.filter(m => m.id && m.name);
                        populateFacultyDropdowns();
                        const member = facultyList.find(m => m.id && m.id.trim() === id.trim());
                        if (member) {
                            document.getElementById('loginScreen').style.display = 'none';
                            document.getElementById('mainFormScreen').style.display = 'block';
                        } else {
                            errorMsg.textContent = "Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª";
                            errorMsg.style.display = 'block';
                        }
                    }
                });
            } catch (error) {
                // ØªØ¬Ø§ÙˆØ² Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainFormScreen').style.display = 'block';
            }
        }

        function populateFacultyDropdowns() {
            const uniqueFaculty = [];
            const map = new Map();
            for (const item of facultyList) {
                if(!map.has(item.id)){
                    map.set(item.id, true);
                    uniqueFaculty.push({ id: item.id, name: item.name });
                }
            }
            uniqueFaculty.sort((a, b) => a.name.localeCompare(b.name, 'ar'));

            const selects = document.querySelectorAll('.faculty-select');
            selects.forEach(select => {
                const firstOption = select.options[0];
                select.innerHTML = '';
                select.appendChild(firstOption);
                if (firstOption.text === "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...") firstOption.text = "-- Ø§Ø®ØªØ± Ø¹Ø¶Ùˆ Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³ --";

                // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø®Ø§Ø±Ø¬ÙŠ ÙÙ‚Ø· Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
                if (select.id.startsWith('thesis_')) {
                    const extOption = document.createElement('option');
                    extOption.value = "external";
                    extOption.text = "ğŸ‘¤ Ù…Ù†Ø§Ù‚Ø´/Ù…Ø´Ø±Ù Ø®Ø§Ø±Ø¬ÙŠ (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ)";
                    extOption.style.color = "#0ea5e9";
                    extOption.style.fontWeight = "bold";
                    select.appendChild(extOption);
                    
                    const separator = document.createElement('option');
                    separator.disabled = true; separator.text = "------------------";
                    select.appendChild(separator);
                }

                uniqueFaculty.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id; option.text = member.name;
                    select.appendChild(option);
                });
            });
        }

        function toggleExternalInput(selectElement) {
            const inputField = selectElement.nextElementSibling;
            if (selectElement.value === 'external') {
                inputField.style.display = 'block';
                inputField.focus();
            } else {
                inputField.style.display = 'none';
                inputField.value = '';
            }
        }

        function getMemberValue(selectId) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(selectId + '_ext');
            return (select.value === 'external') ? input.value.trim() : select.value;
        }

        // ============================================================
        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© (Multi-Select Logic)
        // ============================================================
        function addMemberToList(selectId, listId, hiddenInputId) {
            const select = document.getElementById(selectId);
            const memberId = select.value;
            const memberName = select.options[select.selectedIndex].text;

            if (!memberId || memberId === 'external') return; // Ù„Ø§ Ù†Ù‚Ø¨Ù„ Ø§Ù„ÙØ§Ø±Øº Ø£Ùˆ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ù‡Ù†Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹

            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (!selectedMembersData[hiddenInputId]) {
                selectedMembersData[hiddenInputId] = [];
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
            const exists = selectedMembersData[hiddenInputId].find(m => m.id === memberId);
            if (exists) {
                alert('Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ø¶Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„!');
                return;
            }

            // Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ØµÙÙˆÙØ©
            selectedMembersData[hiddenInputId].push({ id: memberId, name: memberName });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
            renderMembersList(hiddenInputId, listId);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
            select.value = "";
        }

        function removeMemberFromList(memberId, listId, hiddenInputId) {
            if (!selectedMembersData[hiddenInputId]) return;

            selectedMembersData[hiddenInputId] = selectedMembersData[hiddenInputId].filter(m => m.id !== memberId);
            renderMembersList(hiddenInputId, listId);
        }

        function renderMembersList(hiddenInputId, listId) {
            const listContainer = document.getElementById(listId);
            const hiddenInput = document.getElementById(hiddenInputId);
            const members = selectedMembersData[hiddenInputId] || [];

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ (Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…ÙØµÙˆÙ„Ø© Ø¨Ù€ |)
            hiddenInput.value = members.map(m => m.id).join('|');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ø¦ÙŠ
            listContainer.innerHTML = '';
            members.forEach(member => {
                const tag = document.createElement('div');
                tag.className = 'member-tag';
                tag.innerHTML = `
                    ${member.name}
                    <span class="remove-tag" onclick="removeMemberFromList('${member.id}', '${listId}', '${hiddenInputId}')">&times;</span>
                `;
                listContainer.appendChild(tag);
            });
        }

        // ============================================================
        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·
        // ============================================================
        function handleActivityChange() {
            const selection = document.getElementById('mainActivitySelect').value;
            
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.getElementById('submitBtn').style.display = 'none';

            if (!selection) return;

            if (selection === 'pub_research') {
                document.getElementById('form-publications').classList.add('active');
                currentTargetSheet = 'publications';
            } 
            else if (selection.startsWith('thesis_')) {
                document.getElementById('form-theses').classList.add('active');
                currentTargetSheet = 'theses';
            } 
            else if (selection.startsWith('event_')) {
                document.getElementById('form-participations').classList.add('active');
                currentTargetSheet = 'participations';
                
                const categoryField = document.getElementById('part_category_hidden');
                const typeField = document.getElementById('part_type_hidden');

                switch(selection) {
                    case 'event_discussion_external':
                        categoryField.value = 'Ù…Ù†Ø§Ù‚Ø´Ø© Ø®Ø§Ø±Ø¬ÙŠØ©'; typeField.value = 'Ù…Ø´Ø§Ø±ÙƒØ©'; break;
                    case 'event_conf_attend':
                        categoryField.value = 'Ù…Ø¤ØªÙ…Ø±'; typeField.value = 'Ø­Ø¶ÙˆØ±'; break;
                    case 'event_conf_part':
                        categoryField.value = 'Ù…Ø¤ØªÙ…Ø±'; typeField.value = 'Ù…Ø´Ø§Ø±ÙƒØ©'; break;
                    case 'event_workshop_attend':
                        categoryField.value = 'Ù†Ø¯ÙˆØ©/ÙˆØ±Ø´Ø©'; typeField.value = 'Ø­Ø¶ÙˆØ±'; break;
                    case 'event_workshop_part':
                        categoryField.value = 'Ù†Ø¯ÙˆØ©/ÙˆØ±Ø´Ø©'; typeField.value = 'Ù…Ø´Ø§Ø±ÙƒØ©'; break;
                    case 'event_student_research':
                        categoryField.value = 'Ø¨Ø­ÙˆØ« Ø§Ù„Ø·Ù„Ø§Ø¨'; typeField.value = 'Ù†Ø´Ø±'; break;
                }
            }
            
            document.getElementById('submitBtn').style.display = 'block';
        }

        function submitData() {
            const btn = document.getElementById('submitBtn');
            const statusMsg = document.getElementById('statusMsg');

            btn.disabled = true;
            btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
            statusMsg.textContent = "";

            let formData = { formType: currentTargetSheet };

            if (currentTargetSheet === 'publications') {
                formData.year = document.getElementById('pub_year').value;
                formData.title = document.getElementById('pub_title').value;
                // Ù†Ø£Ø®Ø° Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ Ø§Ù„Ø°ÙŠ Ø¹Ø¨Ø£Ù‡ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
                formData.authors_ids = document.getElementById('pub_authors_hidden').value;
                formData.journal = document.getElementById('pub_journal').value;
                formData.publish_date = document.getElementById('pub_date').value;
                formData.citations_range = document.getElementById('pub_citations').value;
                formData.student_author = document.getElementById('pub_student').value;
            }
            else if (currentTargetSheet === 'theses') {
                formData.year = document.getElementById('thesis_year').value;
                formData.type = document.getElementById('thesis_type').value;
                formData.specialization = document.getElementById('thesis_spec').value;
                formData.student_name = document.getElementById('thesis_student_name').value;
                formData.title = document.getElementById('thesis_title').value;
                formData.supervisor_id = getMemberValue('thesis_supervisor');
                formData.co_supervisor_id = getMemberValue('thesis_co_supervisor');
                formData.examiner1_id = getMemberValue('thesis_exam1');
                formData.examiner2_id = getMemberValue('thesis_exam2');
                formData.status = document.getElementById('thesis_status').value;
                formData.defense_date = document.getElementById('thesis_date').value;
            }
            else if (currentTargetSheet === 'participations') {
                formData.year = document.getElementById('part_year').value;
                formData.category = document.getElementById('part_category_hidden').value;
                formData.participation_type = document.getElementById('part_type_hidden').value;
                formData.title = document.getElementById('part_title').value;
                formData.location = document.getElementById('part_location').value;
                formData.date = document.getElementById('part_date').value;
                // Ù†Ø£Ø®Ø° Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ÙÙŠ
                formData.participant_ids = document.getElementById('part_ids_hidden').value;
                formData.organized_by_department = document.getElementById('part_org').value;
                formData.journal = document.getElementById('part_journal').value;
                formData.student_author = document.getElementById('part_student').value;
                formData.notes = document.getElementById('part_notes').value;
                formData.citations_range = ""; formData.granting_body = "";
            }

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(formData),
                headers: { "Content-Type": "text/plain" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusMsg.style.color = 'var(--emerald-500)';
                    statusMsg.textContent = `âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${data.id}`;
                    btn.textContent = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
                    setTimeout(() => { location.reload(); }, 3000);
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusMsg.style.color = 'var(--rose-500)';
                statusMsg.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.";
                btn.disabled = false;
                btn.textContent = "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
            });
        }
    </script>
</body>
</html>
