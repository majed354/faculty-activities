<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุถุงูุฉ ูุดุงุท ุนููู ุฌุฏูุฏ</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-hijri/2.1.2/moment-hijri.min.js"></script>

    <link rel="stylesheet" href="style.css">
    
    <style>
        /* =========================================
           ุชูุณููุงุช ุงูุตูุญุฉ
        ========================================= */
        body { background-color: var(--primary-900); min-height: 100vh; }
        
        .login-container {
            max-width: 400px; margin: 100px auto; padding: 40px;
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(198, 169, 98, 0.3);
            border-radius: 20px; text-align: center; backdrop-filter: blur(10px);
        }
        
        .form-container {
            display: none; max-width: 900px; margin: 40px auto; padding: 30px;
            background: rgba(12, 25, 41, 0.95); border: 1px solid rgba(198, 169, 98, 0.2);
            border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        .form-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px;
        }
        
        .form-section { display: none; animation: fadeIn 0.4s ease; }
        .form-section.active { display: block; }
        
        .input-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .input-grid { grid-template-columns: 1fr; } }
        
        .form-group { margin-bottom: 15px; position: relative; }
        .form-group label { display: block; color: var(--gold-400); margin-bottom: 8px; font-size: 0.9rem; }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1); color: #fff; border-radius: 10px;
            font-family: 'Cairo', sans-serif; transition: all 0.3s;
        }
        
        /* ุชูุณูู ุฎุงุต ูุญูู ุงูุชุงุฑูุฎ ููุธูุฑ ุจุดูู ุฌูุฏ ูู ุงููุถุน ุงููููู */
        input[type="date"] {
            color-scheme: dark; /* ูุฌุนู ุฃููููุฉ ุงูุชูููู ุจูุถุงุก */
        }
        
        .form-group option { background: #1a1a2e; color: #fff; }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--gold-400); background: rgba(255, 255, 255, 0.1);
        }

        .external-input {
            display: none; margin-top: 10px;
            border-color: var(--sky-500) !important;
            background: rgba(14, 165, 233, 0.1) !important;
        }
        .external-input::placeholder { color: #aaa; }

        .btn-submit {
            background: linear-gradient(135deg, var(--gold-500), var(--gold-600)); color: #000;
            font-weight: bold; padding: 15px 40px; border: none; border-radius: 12px;
            cursor: pointer; width: 100%; font-size: 1.1rem; margin-top: 20px; transition: transform 0.2s;
        }
        .btn-submit:hover { transform: translateY(-2px); }
        .btn-submit:disabled { background: #555; cursor: not-allowed; }
        
        .type-selector {
            margin-bottom: 30px; background: rgba(255,255,255,0.05);
            padding: 20px; border-radius: 15px; text-align: center;
        }
        optgroup { color: var(--gold-400); background: #0c1929; font-weight: bold; }

        .multi-select-wrapper { display: flex; gap: 10px; }
        .btn-add-member {
            background: var(--emerald-500); color: white; border: none;
            padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        .btn-add-member:hover { background: var(--emerald-600); }
        
        .selected-members-list {
            margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px;
        }
        .member-tag {
            background: rgba(198, 169, 98, 0.2); border: 1px solid var(--gold-400);
            padding: 5px 10px; border-radius: 15px; font-size: 0.85rem; color: white;
            display: flex; align-items: center; gap: 8px;
        }
        .remove-tag {
            cursor: pointer; color: var(--rose-500); font-weight: bold; font-size: 1.1rem; line-height: 1;
        }
        .remove-tag:hover { color: var(--rose-600); }

        .dynamic-field { display: none; }
        .dynamic-field.visible { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ุชูุณูู ุงูุญููู ุงููุงุฑุบุฉ ุงููุทููุจุฉ */
        .error-field {
            border-color: var(--rose-500) !important;
            background: rgba(244, 63, 94, 0.1) !important;
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .error-message {
            color: var(--rose-500);
            font-size: 0.8rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div class="animated-bg">
        <div class="geometric-pattern"></div>
    </div>

    <div id="loginScreen" class="login-container">
        <h2 style="color: var(--gold-400); margin-bottom: 30px;">๐ ุฏุฎูู ุงูุฃุนุถุงุก</h2>
        <div class="form-group">
            <label>ุงูุฑูู ุงููุธููู</label>
            <input type="text" id="loginId" placeholder="ุฃุฏุฎู ุฑููู ุงููุธููู">
        </div>
        <div class="form-group">
            <label>ูููุฉ ุงููุฑูุฑ</label>
            <input type="password" id="loginPass" placeholder="โขโขโขโข">
        </div>
        <button onclick="attemptLogin()" class="btn-submit">ุฏุฎูู</button>
        <p id="loginError" style="color: var(--rose-500); margin-top: 15px; display: none;">ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ</p>
    </div>

    <div id="mainFormScreen" class="form-container">
        <div class="form-header">
            <h2 style="color: #fff;">ุฅุถุงูุฉ ูุดุงุท ุนููู ุฌุฏูุฏ</h2>
            <a href="index.html" style="color: var(--gold-400); text-decoration: none;">๐ ุนูุฏุฉ ููุฑุฆูุณูุฉ</a>
        </div>

        <div class="type-selector">
            <label style="color: #fff; margin-bottom: 10px; display: block; font-size: 1.1rem;">ุญุฏุฏ ููุน ุงููุดุงุท:</label>
            <select id="mainActivitySelect" onchange="handleActivityChange()" style="width: 100%; max-width: 500px; padding: 12px; border-radius: 8px; font-size: 1rem;">
                <option value="">-- ุงุฎุชุฑ ุงููุดุงุท ูู ุงููุงุฆูุฉ --</option>
                
                <optgroup label="๐ ุงููุดุฑ ุงูุนููู">
                    <option value="pub_research">ุจุญุซ ุนููู ููุดูุฑ (ููุฃุนุถุงุก)</option>
                    <option value="event_student_research">ุจุญุซ ููุดูุฑ ูุทุงูุจ (ุฅุดุฑุงู)</option>
                </optgroup>

                <optgroup label="๐ ุงูุฅุดุฑุงู ูุงูููุงูุดุฉ">
                    <option value="thesis_supervision">ุฅุดุฑุงู ุนูู ุฑุณุงูุฉ ุนูููุฉ</option>
                    <option value="thesis_discussion_internal">ููุงูุดุฉ ุฏุงุฎููุฉ (ุฏุงุฎู ุงููุณู)</option>
                    <option value="event_discussion_external">ููุงูุดุฉ ุฎุงุฑุฌูุฉ (ุฌุงูุนุฉ ุฃุฎุฑู)</option>
                </optgroup>

                <optgroup label="๐ ุงููุคุชูุฑุงุช">
                    <option value="event_conf_attend">ุญุถูุฑ ูุคุชูุฑ</option>
                    <option value="event_conf_participate">ูุดุงุฑูุฉ ูู ูุคุชูุฑ (ุชูุฏูู ูุฑูุฉ/ูุชุญุฏุซ)</option>
                </optgroup>
                
                <optgroup label="๐ฌ ุงููุฏูุงุช">
                    <option value="event_seminar_attend">ุญุถูุฑ ูุฏูุฉ</option>
                    <option value="event_seminar_participate">ูุดุงุฑูุฉ ูู ูุฏูุฉ (ุชูุฏูู/ูุชุญุฏุซ)</option>
                </optgroup>
                
                <optgroup label="๐๏ธ ูุฑุด ุงูุนูู">
                    <option value="event_workshop_attend">ุญุถูุฑ ูุฑุดุฉ ุนูู</option>
                    <option value="event_workshop_participate">ูุดุงุฑูุฉ ูู ูุฑุดุฉ ุนูู</option>
                </optgroup>
                
                <optgroup label="โ ุงูุชุญููู ุงูุนููู">
                    <option value="event_reviewing">ุชุญููู ุนููู (ุจุญูุซ/ุฑุณุงุฆู/ูุฌูุงุช)</option>
                </optgroup>
                
                <optgroup label="๐ ุงูุฌูุงุฆุฒ ูุงูุฅูุฌุงุฒุงุช">
                    <option value="event_award">ุฌุงุฆุฒุฉ ุนูููุฉ</option>
                    <option value="event_patent">ุจุฑุงุกุฉ ุงุฎุชุฑุงุน</option>
                </optgroup>
                
                <optgroup label="๐ ุงูุชุฃููู ูุงููุดุฑ">
                    <option value="event_book">ุชุฃููู / ุชุญููู ูุชุงุจ</option>
                </optgroup>
                
                <optgroup label="๐ผ ุงูุงุณุชุดุงุฑุงุช">
                    <option value="event_consulting">ุงุณุชุดุงุฑุฉ ุนูููุฉ</option>
                </optgroup>
                
                <optgroup label="๐บ ุงูุฅุนูุงู">
                    <option value="event_media">ูุดุงุฑูุฉ ุฅุนูุงููุฉ (ุชููุฒููู/ุฅุฐุงุนุฉ/ุจูุฏูุงุณุช)</option>
                </optgroup>
            </select>
        </div>

        <div id="form-publications" class="form-section">
            <h3 style="color: var(--emerald-500); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">ุจูุงูุงุช ุงูุจุญุซ ุงูููุดูุฑ (ุฃุนุถุงุก)</h3>
            <div class="input-grid">
                <div class="form-group">
                    <label>ุงูุณูุฉ (ูุฌุฑู) <span style="color: var(--rose-500);">*</span></label>
                    <input type="number" id="pub_year" value="1446">
                </div>
                <div class="form-group">
                    <label>ุนููุงู ุงูุจุญุซ <span style="color: var(--rose-500);">*</span></label>
                    <input type="text" id="pub_title">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>๐ค ุงุฎุชุฑ ุงุณูู (ูุฃุณูุงุก ุงูุจุงุญุซูู ูุนู ุฅู ููุฌุฏูุง) <span style="color: var(--rose-500);">*</span></label>
                    <div class="multi-select-wrapper">
                        <select id="pub_author_select" class="faculty-select">
                            <option value="">-- ุงุฎุชุฑ ุงุณูู ูู ุงููุงุฆูุฉ --</option>
                        </select>
                        <button type="button" class="btn-add-member" onclick="addMemberToList('pub_author_select', 'pub_authors_list', 'pub_authors_hidden')">ุฅุถุงูุฉ +</button>
                    </div>
                    <div id="pub_authors_list" class="selected-members-list"></div>
                    <input type="hidden" id="pub_authors_hidden">
                    <small style="color: var(--gray-400);">๐ก ุงุจุฏุฃ ุจุงุฎุชูุงุฑ ุงุณูู ุฃููุงูุ ุซู ุฃุถู ุฃุณูุงุก ุงูุจุงุญุซูู ุงูุขุฎุฑูู ูู ุงููุณู ุฅู ููุฌุฏูุง</small>
                </div>
                <div class="form-group">
                    <label>ุงุณู ุงููุฌูุฉ <span style="color: var(--rose-500);">*</span></label>
                    <input type="text" id="pub_journal">
                </div>
                
                <div class="form-group">
                    <label>ุชุงุฑูุฎ ุงููุดุฑ <span style="color: var(--rose-500);">*</span></label>
                    <input type="date" id="pub_date">
                </div>

                <div class="form-group">
                    <label>ูุทุงู ุงูุงุณุชุดูุงุฏุงุช <span style="color: var(--rose-500);">*</span></label>
                    <select id="pub_citations">
                        <option value="ุฃูู ูู 10">ุฃูู ูู 10</option>
                        <option value="11-20">11-20</option>
                        <option value="21-50">21-50</option>
                        <option value="51-100">51-100</option>
                        <option value="ุฃูุซุฑ ูู 100">ุฃูุซุฑ ูู 100</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ูุดุงุฑูุฉ ุทุงูุจุ</label>
                    <select id="pub_student">
                        <option value="ูุง">ูุง</option>
                        <option value="ูุนู">ูุนู</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="form-theses" class="form-section">
            <h3 style="color: var(--amber-500); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">ุจูุงูุงุช ุงูุฑุณุงูุฉ ุงูุนูููุฉ</h3>
            <div class="input-grid">
                <div class="form-group">
                    <label>ุงูุณูุฉ (ูุฌุฑู) <span style="color: var(--rose-500);">*</span></label>
                    <input type="number" id="thesis_year" value="1446">
                </div>
                <div class="form-group">
                    <label>ุงูุฏุฑุฌุฉ ุงูุนูููุฉ</label>
                    <select id="thesis_type">
                        <option value="ูุงุฌุณุชูุฑ">ูุงุฌุณุชูุฑ</option>
                        <option value="ุฏูุชูุฑุงู">ุฏูุชูุฑุงู</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ุงูุชุฎุตุต</label>
                    <select id="thesis_spec">
                        <option value="ูุฑุงุกุงุช">ูุฑุงุกุงุช</option>
                        <option value="ุฏุฑุงุณุงุช ูุฑุขููุฉ">ุฏุฑุงุณุงุช ูุฑุขููุฉ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ุงุณู ุงูุทุงูุจ <span style="color: var(--rose-500);">*</span></label>
                    <input type="text" id="thesis_student_name">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>ุนููุงู ุงูุฑุณุงูุฉ <span style="color: var(--rose-500);">*</span></label>
                    <input type="text" id="thesis_title">
                </div>

                <div class="form-group">
                    <label>ุงููุดุฑู ุงูุฑุฆูุณู <span style="color: var(--rose-500);">*</span></label>
                    <select id="thesis_supervisor" class="faculty-select" onchange="toggleExternalInput(this)">
                        <option value="">ุฌุงุฑู ุงูุชุญููู...</option>
                    </select>
                    <input type="text" id="thesis_supervisor_ext" class="external-input" placeholder="ุงุณู ุงููุดุฑู ุงูุฎุงุฑุฌู...">
                </div>

                <div class="form-group">
                    <label>ุงููุดุฑู ุงููุดุงุฑู</label>
                    <select id="thesis_co_supervisor" class="faculty-select" onchange="toggleExternalInput(this)">
                        <option value="">-- ุงุฎุชูุงุฑู --</option>
                    </select>
                    <input type="text" id="thesis_co_supervisor_ext" class="external-input" placeholder="ุงุณู ุงููุดุฑู ุงููุดุงุฑู...">
                </div>

                <div class="form-group">
                    <label>ุงูููุงูุด ุงูุฃูู <span style="color: var(--rose-500);">*</span></label>
                    <select id="thesis_exam1" class="faculty-select" onchange="toggleExternalInput(this)">
                        <option value="">ุฌุงุฑู ุงูุชุญููู...</option>
                    </select>
                    <input type="text" id="thesis_exam1_ext" class="external-input" placeholder="ุงุณู ุงูููุงูุด ุงูุฎุงุฑุฌู...">
                </div>

                <div class="form-group">
                    <label>ุงูููุงูุด ุงูุซุงูู <span style="color: var(--rose-500);">*</span></label>
                    <select id="thesis_exam2" class="faculty-select" onchange="toggleExternalInput(this)">
                        <option value="">ุฌุงุฑู ุงูุชุญููู...</option>
                    </select>
                    <input type="text" id="thesis_exam2_ext" class="external-input" placeholder="ุงุณู ุงูููุงูุด ุงูุฎุงุฑุฌู...">
                </div>

                <div class="form-group">
                    <label>ุญุงูุฉ ุงูุฑุณุงูุฉ</label>
                    <select id="thesis_status">
                        <option value="ููุฌุฒุฉ">ููุฌุฒุฉ</option>
                        <option value="ุฌุงุฑูุฉ">ุฌุงุฑูุฉ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ุชุงุฑูุฎ ุงูููุงูุดุฉ</label>
                    <input type="date" id="thesis_date">
                </div>
            </div>
        </div>

        <div id="form-participations" class="form-section">
            <h3 style="color: var(--violet-500); margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">ุจูุงูุงุช ุงููุนุงููุฉ / ุงูุฃูุดุทุฉ</h3>
            
            <input type="hidden" id="part_category_hidden">
            <input type="hidden" id="part_type_hidden">

            <div class="input-grid">
                <div class="form-group">
                    <label>ุงูุณูุฉ (ูุฌุฑู) <span style="color: var(--rose-500);">*</span></label>
                    <input type="number" id="part_year" value="1446">
                </div>
                
                <div class="form-group">
                    <label id="part_title_label">ุนููุงู ุงููุนุงููุฉ / ุงููุดุงุท <span style="color: var(--rose-500);">*</span></label>
                    <input type="text" id="part_title">
                </div>

                <div id="div_student_name" class="form-group dynamic-field">
                    <label style="color: var(--sky-500);">ุงุณู ุงูุทุงูุจ ุงูุจุงุญุซ <span style="color: var(--rose-500);">*</span></label>
                    <input type="text" id="part_student_name" placeholder="ุฃุฏุฎู ุงุณู ุงูุทุงูุจ...">
                </div>

                <div class="form-group">
                    <label id="part_location_label">ุงูููุงู / ุงูุฌูุฉ ุงูููุธูุฉ</label>
                    <input type="text" id="part_location">
                </div>
                
                <div class="form-group">
                    <label>ุงูุชุงุฑูุฎ</label>
                    <input type="date" id="part_date">
                </div>

                <div class="form-group" style="grid-column: span 2;">
                    <label id="part_ids_label">๐ค ุงุฎุชุฑ ุงุณูู (ูุฃุณูุงุก ุงููุดุงุฑููู ูุนู ุฅู ููุฌุฏูุง) <span style="color: var(--rose-500);">*</span></label>
                    <div class="multi-select-wrapper">
                        <select id="part_ids_select" class="faculty-select">
                            <option value="">-- ุงุฎุชุฑ ุงุณูู ูู ุงููุงุฆูุฉ --</option>
                        </select>
                        <button type="button" class="btn-add-member" onclick="addMemberToList('part_ids_select', 'part_ids_list', 'part_ids_hidden')">ุฅุถุงูุฉ +</button>
                    </div>
                    <div id="part_ids_list" class="selected-members-list"></div>
                    <input type="hidden" id="part_ids_hidden">
                    <small style="color: var(--gray-400);">๐ก ุงุจุฏุฃ ุจุงุฎุชูุงุฑ ุงุณูู ุฃููุงูุ ุซู ุฃุถู ุฃุณูุงุก ุงููุดุงุฑููู ุงูุขุฎุฑูู ูู ุงููุณู ุฅู ููุฌุฏูุง</small>
                </div>

                <div id="div_org" class="form-group dynamic-field">
                    <label>ุชูุธูู ุงููุณูุ</label>
                    <select id="part_org">
                        <option value="ูุง">ูุง</option>
                        <option value="ูุนู">ูุนู</option>
                    </select>
                </div>
                
                <div id="div_attendance" class="form-group dynamic-field">
                    <label style="color: var(--sky-500);">ุนุฏุฏ ุงูุญุถูุฑ (ุชูุฑูุจู)</label>
                    <input type="number" id="part_attendance" placeholder="ูุซุงู: 45">
                </div>
                
                <div class="form-group" id="div_student_participation">
                    <label>ูุดุงุฑูุฉ ุทุงูุจุ</label>
                    <select id="part_student">
                        <option value="ูุง">ูุง</option>
                        <option value="ูุนู">ูุนู</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>ููุงุญุธุงุช ุฅุถุงููุฉ</label>
                <textarea id="part_notes" rows="2"></textarea>
            </div>
        </div>

        <p style="color: var(--gray-400); font-size: 0.85rem; margin-bottom: 10px; text-align: center;">
            <span style="color: var(--rose-500);">*</span> ุงูุญููู ุงููููุฒุฉ ุจูุฌูุฉ ุญูุฑุงุก ุฅูุฒุงููุฉ
        </p>
        <button id="submitBtn" onclick="submitData()" class="btn-submit" style="display:none;">๐ค ุญูุธ ูุฅุฑุณุงู ุงูุจูุงูุงุช</button>
        <p id="statusMsg" style="text-align: center; margin-top: 15px; font-weight: bold;"></p>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbIi7bIwIZCXPtUHnUt5bS2GJAZZjfFqgKSqyEnC97KOPwx03ZGkXCFdZRTcndZOuM/exec';
        let facultyList = [];
        let currentTargetSheet = '';
        let selectedMembersData = {};

        // ุถุจุท ุชุงุฑูุฎ ุงูููู ููููุฉ ุงูุชุฑุงุถูุฉ ูุฌููุน ุญููู ุงูุชุงุฑูุฎ ุนูุฏ ุงูุชุญููู
        window.addEventListener('load', function() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = today;
            });
            
            // ุฅุฒุงูุฉ ุชูุณูู ุงูุฎุทุฃ ุนูุฏ ุงููุชุงุจุฉ ูู ุฃู ุญูู
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.addEventListener('input', function() {
                    this.classList.remove('error-field');
                });
                el.addEventListener('change', function() {
                    this.classList.remove('error-field');
                });
            });
        });

        // ุฏุงูุฉ ุชุญููู ุงูุชุงุฑูุฎ ูู ูููุงุฏู ุฅูู ูุฌุฑู (YYYY-MM-DD)
        function convertToHijri(gregorianDate) {
            if (!gregorianDate) return "";
            // ุชุญููู ุจุงุณุชุฎุฏุงู Moment-Hijri
            return moment(gregorianDate, 'YYYY-MM-DD').format('iYYYY-iMM-iDD');
        }

        async function attemptLogin() {
            const id = document.getElementById('loginId').value;
            const pass = document.getElementById('loginPass').value;
            const errorMsg = document.getElementById('loginError');

            if (pass !== '1429') {
                errorMsg.textContent = "ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ";
                errorMsg.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('./data/faculty.csv');
                if (!response.ok) throw new Error("File not found");
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    complete: function(results) {
                        facultyList = results.data.filter(m => m.id && m.name);
                        populateFacultyDropdowns();
                        const member = facultyList.find(m => m.id && m.id.trim() === id.trim());
                        if (member) {
                            document.getElementById('loginScreen').style.display = 'none';
                            document.getElementById('mainFormScreen').style.display = 'block';
                        } else {
                            errorMsg.textContent = "ุฑูู ุงูุนุถู ุบูุฑ ููุฌูุฏ ูู ุงูุณุฌูุงุช";
                            errorMsg.style.display = 'block';
                        }
                    }
                });
            } catch (error) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainFormScreen').style.display = 'block';
            }
        }

        function populateFacultyDropdowns() {
            const uniqueFaculty = [];
            const map = new Map();
            for (const item of facultyList) {
                if(!map.has(item.id)){
                    map.set(item.id, true);
                    uniqueFaculty.push({ id: item.id, name: item.name });
                }
            }
            uniqueFaculty.sort((a, b) => a.name.localeCompare(b.name, 'ar'));

            const selects = document.querySelectorAll('.faculty-select');
            selects.forEach(select => {
                const firstOption = select.options[0];
                select.innerHTML = '';
                select.appendChild(firstOption);
                if (firstOption.text === "ุฌุงุฑู ุงูุชุญููู...") firstOption.text = "-- ุงุฎุชุฑ ุนุถู ููุฆุฉ ุงูุชุฏุฑูุณ --";

                if (select.id.startsWith('thesis_')) {
                    const extOption = document.createElement('option');
                    extOption.value = "external";
                    extOption.text = "๐ค ููุงูุด/ูุดุฑู ุฎุงุฑุฌู (ุฅุฏุฎุงู ูุฏูู)";
                    extOption.style.color = "#0ea5e9";
                    extOption.style.fontWeight = "bold";
                    select.appendChild(extOption);
                    const separator = document.createElement('option');
                    separator.disabled = true; separator.text = "------------------";
                    select.appendChild(separator);
                }

                uniqueFaculty.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id; option.text = member.name;
                    select.appendChild(option);
                });
            });
        }

        function toggleExternalInput(selectElement) {
            const inputField = selectElement.nextElementSibling;
            if (selectElement.value === 'external') {
                inputField.style.display = 'block';
                inputField.focus();
            } else {
                inputField.style.display = 'none';
                inputField.value = '';
            }
        }

        function getMemberValue(selectId) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(selectId + '_ext');
            return (select.value === 'external') ? input.value.trim() : select.value;
        }

        function addMemberToList(selectId, listId, hiddenInputId) {
            const select = document.getElementById(selectId);
            const memberId = select.value;
            const memberName = select.options[select.selectedIndex].text;
            if (!memberId || memberId === 'external') return;

            if (!selectedMembersData[hiddenInputId]) selectedMembersData[hiddenInputId] = [];
            
            const exists = selectedMembersData[hiddenInputId].find(m => m.id === memberId);
            if (exists) { alert('ูุฐุง ุงูุนุถู ูุถุงู ุจุงููุนู!'); return; }

            selectedMembersData[hiddenInputId].push({ id: memberId, name: memberName });
            renderMembersList(hiddenInputId, listId);
            select.value = "";
        }

        function removeMemberFromList(memberId, listId, hiddenInputId) {
            if (!selectedMembersData[hiddenInputId]) return;
            selectedMembersData[hiddenInputId] = selectedMembersData[hiddenInputId].filter(m => m.id !== memberId);
            renderMembersList(hiddenInputId, listId);
        }

        function renderMembersList(hiddenInputId, listId) {
            const listContainer = document.getElementById(listId);
            const hiddenInput = document.getElementById(hiddenInputId);
            const members = selectedMembersData[hiddenInputId] || [];
            hiddenInput.value = members.map(m => m.id).join('|');
            listContainer.innerHTML = '';
            members.forEach(member => {
                const tag = document.createElement('div');
                tag.className = 'member-tag';
                tag.innerHTML = `${member.name} <span class="remove-tag" onclick="removeMemberFromList('${member.id}', '${listId}', '${hiddenInputId}')">&times;</span>`;
                listContainer.appendChild(tag);
            });
        }

        function handleActivityChange() {
            const selection = document.getElementById('mainActivitySelect').value;
            
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.getElementById('submitBtn').style.display = 'none';
            document.querySelectorAll('.dynamic-field').forEach(el => el.classList.remove('visible'));

            if (!selection) return;

            if (selection === 'pub_research') {
                document.getElementById('form-publications').classList.add('active');
                currentTargetSheet = 'publications';
            } 
            else if (selection.startsWith('thesis_')) {
                document.getElementById('form-theses').classList.add('active');
                currentTargetSheet = 'theses';
            } 
            else if (selection.startsWith('event_')) {
                document.getElementById('form-participations').classList.add('active');
                currentTargetSheet = 'participations';
                
                const categoryField = document.getElementById('part_category_hidden');
                const typeField = document.getElementById('part_type_hidden');
                
                // ุฅุนุงุฏุฉ ุชุนููู ุงูุชุณููุงุช ุงูุงูุชุฑุงุถูุฉ
                document.getElementById('part_title_label').textContent = "ุนููุงู ุงููุนุงููุฉ / ุงููุดุงุท";
                document.getElementById('part_location_label').textContent = "ุงูููุงู / ุงูุฌูุฉ ุงูููุธูุฉ";
                document.getElementById('part_ids_label').textContent = "ุงูุฃุนุถุงุก ุงููุดุงุฑููู (ูู ุงููุณู)";

                // ====== ุงูููุงูุดุฉ ุงูุฎุงุฑุฌูุฉ ======
                if (selection === 'event_discussion_external') {
                    categoryField.value = 'ููุงูุดุฉ ุฎุงุฑุฌูุฉ';
                    typeField.value = 'ููุงูุดุฉ';
                    document.getElementById('part_title_label').textContent = "ุนููุงู ุงูุฑุณุงูุฉ";
                    document.getElementById('part_location_label').textContent = "ุงูุฌุงูุนุฉ / ุงูุฌูุฉ";
                    document.getElementById('part_ids_label').textContent = "ุงูููุงูุด (ุนุถู ููุฆุฉ ุงูุชุฏุฑูุณ)";
                }
                // ====== ุงููุคุชูุฑุงุช ======
                else if (selection === 'event_conf_attend') {
                    categoryField.value = 'ูุคุชูุฑ';
                    typeField.value = 'ุญุถูุฑ';
                }
                else if (selection === 'event_conf_participate') {
                    categoryField.value = 'ูุคุชูุฑ';
                    typeField.value = 'ูุดุงุฑูุฉ';
                    document.getElementById('part_title_label').textContent = "ุนููุงู ุงููุฑูุฉ / ุงููุดุงุฑูุฉ";
                }
                // ====== ุงููุฏูุงุช ======
                else if (selection === 'event_seminar_attend') {
                    categoryField.value = 'ูุฏูุฉ';
                    typeField.value = 'ุญุถูุฑ';
                }
                else if (selection === 'event_seminar_participate') {
                    categoryField.value = 'ูุฏูุฉ';
                    typeField.value = 'ูุดุงุฑูุฉ';
                    document.getElementById('div_org').classList.add('visible');
                    document.getElementById('div_attendance').classList.add('visible');
                }
                // ====== ูุฑุด ุงูุนูู ======
                else if (selection === 'event_workshop_attend') {
                    categoryField.value = 'ูุฑุดุฉ ุนูู';
                    typeField.value = 'ุญุถูุฑ';
                }
                else if (selection === 'event_workshop_participate') {
                    categoryField.value = 'ูุฑุดุฉ ุนูู';
                    typeField.value = 'ูุดุงุฑูุฉ';
                    document.getElementById('div_org').classList.add('visible');
                    document.getElementById('div_attendance').classList.add('visible');
                }
                // ====== ุจุญูุซ ุงูุทูุงุจ ======
                else if (selection === 'event_student_research') {
                    categoryField.value = 'ุจุญูุซ ุงูุทูุงุจ';
                    typeField.value = 'ูุดุฑ';
                    document.getElementById('div_student_name').classList.add('visible');
                    document.getElementById('part_title_label').textContent = "ุนููุงู ุงูุจุญุซ";
                    document.getElementById('part_location_label').textContent = "ุงุณู ุงููุฌูุฉ / ุฌูุฉ ุงููุดุฑ";
                    document.getElementById('part_ids_label').textContent = "ุงููุดุฑู (ุนุถู ููุฆุฉ ุงูุชุฏุฑูุณ)";
                }
                // ====== ุงูุชุญููู ุงูุนููู ======
                else if (selection === 'event_reviewing') {
                    categoryField.value = 'ุชุญููู ุนููู';
                    typeField.value = 'ูุดุงุฑูุฉ';
                    document.getElementById('part_title_label').textContent = "ูุตู ุงูุชุญููู (ุจุญุซ/ุฑุณุงูุฉ/ูุฌูุฉ)";
                    document.getElementById('part_location_label').textContent = "ุงูุฌูุฉ ุงููุญูู ููุง";
                    document.getElementById('part_ids_label').textContent = "ุงููุญูู (ุนุถู ููุฆุฉ ุงูุชุฏุฑูุณ)";
                }
                // ====== ุงูุฌูุงุฆุฒ ======
                else if (selection === 'event_award') {
                    categoryField.value = 'ุฌุงุฆุฒุฉ';
                    typeField.value = 'ูุดุงุฑูุฉ';
                    document.getElementById('part_title_label').textContent = "ุงุณู ุงูุฌุงุฆุฒุฉ";
                    document.getElementById('part_location_label').textContent = "ุงูุฌูุฉ ุงููุงูุญุฉ";
                    document.getElementById('part_ids_label').textContent = "ุงูุญุงุตู ุนูู ุงูุฌุงุฆุฒุฉ";
                }
                // ====== ุจุฑุงุกุฉ ุงูุงุฎุชุฑุงุน ======
                else if (selection === 'event_patent') {
                    categoryField.value = 'ุจุฑุงุกุฉ ุงุฎุชุฑุงุน';
                    typeField.value = 'ูุดุงุฑูุฉ';
                    document.getElementById('part_title_label').textContent = "ุนููุงู ุจุฑุงุกุฉ ุงูุงุฎุชุฑุงุน";
                    document.getElementById('part_location_label').textContent = "ุงูุฌูุฉ ุงููุณุฌูุฉ ูุฏููุง";
                    document.getElementById('part_ids_label').textContent = "ุตุงุญุจ ุงูุจุฑุงุกุฉ";
                }
                // ====== ุชุฃููู ูุชุจ ======
                else if (selection === 'event_book') {
                    categoryField.value = 'ุชุฃููู ูุชุจ';
                    typeField.value = 'ูุดุฑ';
                    document.getElementById('part_title_label').textContent = "ุนููุงู ุงููุชุงุจ";
                    document.getElementById('part_location_label').textContent = "ุฏุงุฑ ุงููุดุฑ";
                    document.getElementById('part_ids_label').textContent = "ุงููุคูู / ุงููุญูู";
                }
                // ====== ุงุณุชุดุงุฑุฉ ุนูููุฉ ======
                else if (selection === 'event_consulting') {
                    categoryField.value = 'ุงุณุชุดุงุฑุฉ ุนูููุฉ';
                    typeField.value = 'ูุดุงุฑูุฉ';
                    document.getElementById('part_title_label').textContent = "ููุถูุน ุงูุงุณุชุดุงุฑุฉ";
                    document.getElementById('part_location_label').textContent = "ุงูุฌูุฉ ุงููุณุชููุฏุฉ";
                    document.getElementById('part_ids_label').textContent = "ุงููุณุชุดุงุฑ";
                }
                // ====== ูุดุงุฑูุฉ ุฅุนูุงููุฉ ======
                else if (selection === 'event_media') {
                    categoryField.value = 'ูุดุงุฑูุฉ ุฅุนูุงููุฉ';
                    typeField.value = 'ูุดุงุฑูุฉ';
                    document.getElementById('part_title_label').textContent = "ุนููุงู ุงูููุงุก / ุงูุจุฑูุงูุฌ";
                    document.getElementById('part_location_label').textContent = "ุงูููุงุฉ / ุงูุฅุฐุงุนุฉ / ุงูููุตุฉ";
                    document.getElementById('part_ids_label').textContent = "ุงููุดุงุฑู";
                }
            }
            
            document.getElementById('submitBtn').style.display = 'block';
        }

        // ========================================
        // ุฏุงูุฉ ุงูุชุญูู ูู ุงูุญููู ุงูุฅูุฒุงููุฉ
        // ========================================
        function validateForm() {
            let errors = [];
            let firstErrorField = null;
            
            // ุฅุฒุงูุฉ ุงูุชูุณููุงุช ุงูุณุงุจูุฉ ููุฃุฎุทุงุก
            document.querySelectorAll('.error-field').forEach(el => el.classList.remove('error-field'));
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            
            if (currentTargetSheet === 'publications') {
                // ุงูุญููู ุงูุฅูุฒุงููุฉ ููุจุญูุซ
                const requiredFields = [
                    { id: 'pub_year', name: 'ุงูุณูุฉ' },
                    { id: 'pub_title', name: 'ุนููุงู ุงูุจุญุซ' },
                    { id: 'pub_authors_hidden', name: 'ุงุฎุชูุงุฑ ุงุณูู' },
                    { id: 'pub_journal', name: 'ุงุณู ุงููุฌูุฉ' },
                    { id: 'pub_date', name: 'ุชุงุฑูุฎ ุงููุดุฑ' },
                    { id: 'pub_citations', name: 'ูุทุงู ุงูุงุณุชุดูุงุฏุงุช' }
                ];
                
                requiredFields.forEach(field => {
                    const el = document.getElementById(field.id);
                    if (!el || !el.value.trim()) {
                        errors.push(field.name);
                        if (el) {
                            el.classList.add('error-field');
                            if (!firstErrorField) firstErrorField = el;
                        }
                    }
                });
            }
            else if (currentTargetSheet === 'theses') {
                // ุงูุญููู ุงูุฅูุฒุงููุฉ ููุฑุณุงุฆู
                const requiredFields = [
                    { id: 'thesis_year', name: 'ุงูุณูุฉ' },
                    { id: 'thesis_student_name', name: 'ุงุณู ุงูุทุงูุจ' },
                    { id: 'thesis_title', name: 'ุนููุงู ุงูุฑุณุงูุฉ' },
                    { id: 'thesis_supervisor', name: 'ุงููุดุฑู ุงูุฑุฆูุณู', isSelect: true },
                    { id: 'thesis_exam1', name: 'ุงูููุงูุด ุงูุฃูู', isSelect: true },
                    { id: 'thesis_exam2', name: 'ุงูููุงูุด ุงูุซุงูู', isSelect: true }
                ];
                
                requiredFields.forEach(field => {
                    const el = document.getElementById(field.id);
                    let isEmpty = false;
                    
                    if (field.isSelect) {
                        isEmpty = !el || !el.value || el.value === '' || el.value === 'external';
                        // ุฅุฐุง ูุงู ุฎุงุฑุฌูุ ุชุญูู ูู ุญูู ุงูุฅุฏุฎุงู ุงูุฎุงุฑุฌู
                        if (el && el.value === 'external') {
                            const extInput = document.getElementById(field.id + '_ext');
                            isEmpty = !extInput || !extInput.value.trim();
                        }
                    } else {
                        isEmpty = !el || !el.value.trim();
                    }
                    
                    if (isEmpty) {
                        errors.push(field.name);
                        if (el) {
                            el.classList.add('error-field');
                            if (!firstErrorField) firstErrorField = el;
                        }
                    }
                });
                
                // ุชุญูู ูู ุชุงุฑูุฎ ุงูููุงูุดุฉ ุฅุฐุง ูุงูุช ุงูุฑุณุงูุฉ ููุฌุฒุฉ
                const status = document.getElementById('thesis_status').value;
                if (status === 'ููุฌุฒุฉ') {
                    const dateEl = document.getElementById('thesis_date');
                    if (!dateEl || !dateEl.value) {
                        errors.push('ุชุงุฑูุฎ ุงูููุงูุดุฉ (ูุทููุจ ููุฑุณุงุฆู ุงูููุฌุฒุฉ)');
                        if (dateEl) {
                            dateEl.classList.add('error-field');
                            if (!firstErrorField) firstErrorField = dateEl;
                        }
                    }
                }
            }
            else if (currentTargetSheet === 'participations') {
                // ุงูุญููู ุงูุฅูุฒุงููุฉ ูููุดุงุฑูุงุช
                const requiredFields = [
                    { id: 'part_year', name: 'ุงูุณูุฉ' },
                    { id: 'part_title', name: 'ุงูุนููุงู' },
                    { id: 'part_ids_hidden', name: 'ุงุฎุชูุงุฑ ุงุณูู' }
                ];
                
                requiredFields.forEach(field => {
                    const el = document.getElementById(field.id);
                    if (!el || !el.value.trim()) {
                        errors.push(field.name);
                        if (el) {
                            el.classList.add('error-field');
                            if (!firstErrorField) firstErrorField = el;
                        }
                    }
                });
                
                // ุชุญูู ูู ุงุณู ุงูุทุงูุจ ุฅุฐุง ูุงูุช ุงููุฆุฉ ุจุญูุซ ุงูุทูุงุจ
                const category = document.getElementById('part_category_hidden').value;
                if (category === 'ุจุญูุซ ุงูุทูุงุจ') {
                    const studentNameEl = document.getElementById('part_student_name');
                    if (!studentNameEl || !studentNameEl.value.trim()) {
                        errors.push('ุงุณู ุงูุทุงูุจ ุงูุจุงุญุซ');
                        if (studentNameEl) {
                            studentNameEl.classList.add('error-field');
                            if (!firstErrorField) firstErrorField = studentNameEl;
                        }
                    }
                }
            }
            
            // ุนุฑุถ ุฑุณุงูุฉ ุงูุฎุทุฃ ุฅุฐุง ูุฌุฏุช ุฃุฎุทุงุก
            if (errors.length > 0) {
                const statusMsg = document.getElementById('statusMsg');
                statusMsg.style.color = 'var(--rose-500)';
                statusMsg.innerHTML = `โ๏ธ ูุฑุฌู ุฅููุงู ุงูุญููู ุงูุชุงููุฉ:<br><strong>${errors.join('ุ ')}</strong>`;
                
                // ุงูุชูุฑูุฑ ููุญูู ุงูุฃูู ุงููุงุฑุบ
                if (firstErrorField) {
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstErrorField.focus();
                }
                
                return false;
            }
            
            return true;
        }

        function submitData() {
            // ุงูุชุญูู ูู ุงูุญููู ุงูุฅูุฒุงููุฉ ุฃููุงู
            if (!validateForm()) {
                return;
            }
            
            const btn = document.getElementById('submitBtn');
            const statusMsg = document.getElementById('statusMsg');

            btn.disabled = true; btn.textContent = "ุฌุงุฑู ุงูุฅุฑุณุงู..."; statusMsg.textContent = "";

            let formData = { formType: currentTargetSheet };

            // 1. ุฌูุน ุงูุจูุงูุงุช (ูุน ุชุญููู ุงูุชุงุฑูุฎ ูููุฌุฑู)
            if (currentTargetSheet === 'publications') {
                formData.year = document.getElementById('pub_year').value;
                formData.title = document.getElementById('pub_title').value;
                formData.authors_ids = document.getElementById('pub_authors_hidden').value;
                formData.journal = document.getElementById('pub_journal').value;
                formData.publish_date = convertToHijri(document.getElementById('pub_date').value); // ุชุญููู
                formData.citations_range = document.getElementById('pub_citations').value;
                formData.student_author = document.getElementById('pub_student').value;
            }
            else if (currentTargetSheet === 'theses') {
                formData.year = document.getElementById('thesis_year').value;
                formData.type = document.getElementById('thesis_type').value;
                formData.specialization = document.getElementById('thesis_spec').value;
                formData.student_name = document.getElementById('thesis_student_name').value;
                formData.title = document.getElementById('thesis_title').value;
                formData.supervisor_id = getMemberValue('thesis_supervisor');
                formData.co_supervisor_id = getMemberValue('thesis_co_supervisor');
                formData.examiner1_id = getMemberValue('thesis_exam1');
                formData.examiner2_id = getMemberValue('thesis_exam2');
                formData.status = document.getElementById('thesis_status').value;
                formData.defense_date = convertToHijri(document.getElementById('thesis_date').value); // ุชุญููู
            }
            else if (currentTargetSheet === 'participations') {
                formData.year = document.getElementById('part_year').value;
                formData.category = document.getElementById('part_category_hidden').value;
                formData.participation_type = document.getElementById('part_type_hidden').value;
                
                let finalTitle = document.getElementById('part_title').value;
                let studentDetails = "";

                const studentNameInput = document.getElementById('part_student_name');
                if (formData.category === 'ุจุญูุซ ุงูุทูุงุจ' && studentNameInput && studentNameInput.value) {
                    finalTitle = `ุฅุดุฑุงู ุนูู ูุดุฑ ุจุญุซ ููุทุงูุจ: ${studentNameInput.value} - ุจุนููุงู: ${finalTitle}`;
                    studentDetails = studentNameInput.value; 
                } 
                else if (document.getElementById('part_attendance') && document.getElementById('part_attendance').value) {
                    studentDetails = document.getElementById('part_attendance').value; 
                }

                formData.title = finalTitle;
                formData.location = document.getElementById('part_location').value;
                formData.date = convertToHijri(document.getElementById('part_date').value);
                formData.participant_ids = document.getElementById('part_ids_hidden').value;
                formData.organized_by_department = document.getElementById('part_org')?.value || 'ูุง';
                formData.student_details = studentDetails; 
                formData.notes = document.getElementById('part_notes').value;
            }

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(formData),
                headers: { "Content-Type": "text/plain" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusMsg.style.color = 'var(--emerald-500)';
                    statusMsg.textContent = `โ ุชู ุงูุญูุธ ุจูุฌุงุญ! ุฑูู ุงูุนูููุฉ: ${data.id}`;
                    btn.disabled = false;
                    btn.textContent = "๐ค ุญูุธ ูุฅุฑุณุงู ุงูุจูุงูุงุช";
                    
                    // ุชูุธูู ุงูุญููู ุงููุตูุฉ ููุท ูุชุณููู ุงูุฅุถุงูุฉ ุงูุชุงููุฉ
                    clearInputsAfterSuccess();
                    
                    alert("ุชูุช ุฅุถุงูุฉ ุงููุดุงุท ุจูุฌุงุญ. ููููู ุฅุถุงูุฉ ูุดุงุท ุขุฎุฑ.");
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusMsg.style.color = 'var(--rose-500)';
                statusMsg.textContent = "โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุฅุฑุณุงู.";
                btn.disabled = false;
                btn.textContent = "ุญุงูู ูุฑุฉ ุฃุฎุฑู";
            });
        }

        // ุฏุงูุฉ ูุชูุฑูุบ ุงูุญููู ุงููุตูุฉ ููุท ุจุนุฏ ุงูุญูุธ
        function clearInputsAfterSuccess() {
            const inputs = document.querySelectorAll('.active input[type="text"]:not([readonly]), .active textarea');
            inputs.forEach(input => input.value = "");
            // ูุง ููุฑุบ ุงูููุงุฆู ุงูููุณุฏูุฉ ููุง ุงูุชูุงุฑูุฎ (ุชุจูู ุนูู ูุถุนูุง ูุชุณุฑูุน ุงูุฅุฏุฎุงู ุงููุชูุฑุฑ)
        }
    </script>
</body>
</html>
